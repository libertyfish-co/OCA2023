## 12.1 Ruby on Rails：ECサイトの開発 セッションと複数商品の注文1

商品がそろってきたので買い物カートを追加し、ユーザーが複数の商品を一括で購入できるようにし、管理画面も複数商品購入の管理ができるように、変更しましょう。
今回は、買い物カートを実現するためにセッションを利用します。まずは、セッションの機能と注意点から見ていきましょう。

- - -

### 12.1.1 セッション機能について

#### (a) 解説

##### セッションとは何か

アプリケーションでは、特定のユーザーがどのような状態にあるかを観測したり識別したりすることがあります。例えば、ショッピングサイトの買い物カゴや、現在ログインしているユーザーの情報などです。
しかし、HTTPは基本的にステートレスプロトコルなので、カート情報やユーザ情報を次のHTTPリクエストまで保持しておくことができません。HTTPのリクエストを発行するたびにカートが空になってしまったり、ログインを行わなければならなくなります。
このため、これらの有効な情報を保持してステートフルを実現するため、Webアプリケーションのセッションを利用します。デフォルトではセッション情報はブラウザのクッキーに保存されます。アプリケーション層のセッションデータとブラウザのセッションデータの照合をすることで、ステートフルを実現しています。

_ _ _

##### Railsでのセッションの機能について

Railsは、ユーザーがアプリケーションに新しくアクセスするときに自動的にセッションを作成します。ユーザーが既にアプリケーションを使用中であれば、既存のセッションを読み込みます。そして、コントローラーでsessionインスタンスを使うことで、セッションに値を設定/取得といったアクセスができます。
なお、Rails4.0以降では内容が暗号化されていますので、ブラウザ上でクッキーの値からセッションの内容を簡単に確認することはできません。暗号化に使われた秘密鍵の値を知っていれば、復号化して、セッションの内容を確認することが可能となります。

_ _ _

###### セッションを使うときの注意点

 - 秘密情報を保持しない：デフォルトのセッションデータは、クッキーに保存されます。そのため、暗号化で改ざん防止機構はついていますが、内容を確認することができてしまうため、秘密情報は保持しないようにしましょう。
 - セッションには巨大なオブジェクトを格納しない：クッキーは4KB弱という容量制限があります。Railsのセッションの使われ方として、セッションに入れるデータはユーザーのIDとflash程度にとどめることが推奨されています。
 - マーシャルできないオブジェクトは入れられない：セッションにデータを格納すると、保存対象のオブジェクトはMarshal#dumpによってシリアライズされて保存されます。これは、IOオブジェクトやProcオブジェクトなど、シリアライズできないオブジェクトはセッションに格納することができないという意味です。
