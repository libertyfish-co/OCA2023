## 7.6 Ruby on Rails：ECサイトの開発 商品一覧1

### 7.6.1 商品一覧の作成

ここからは、要求仕様に従ってECサイトを構築していきます。なるべくRailsらしい機能やデフォルトの設定を使っていきますが、プロジェクトによっていろいろな方法や考え方をするときがあります。これらがすべてではないということを頭の片隅に置いておいてください。

また、gitを利用して適切なバージョン管理を心がけてください。gitにまだ自信がない人はgitコマンドを復習し、まずはコマンドを実行するごと、1つのファイルを変更するごとにコミットする癖をつけましょう。

### 7.6.2 ECサイトの概要とタイムゾーンの設定

#### (a) 解説

今回構築するECサイトの要求仕様は次のとおりです。一般的なECサイトよりは機能が少なめですが、Railsでアプリを作る際に必要なことはほぼ網羅しています。

 1. 管理画面  
   1.1 商品のCRUDと商品画像のアップロード  
   1.2 管理者のログイン認証  
   1.3 注文状態（全体）の確認  
   1.4 カート状態（全体）の確認  
 2. ユーザー画面  
   2.1 商品一覧と商品詳細ページ  
   2.2 商品の注文  
   2.3 注文完了後のメール送信  
   2.4 商品検索  

もし、アプリをゼロから作ったことがない方は、要求仕様をもらったあとの構築手順も考えてみましょう。自社サービスの開発などでは必ずしもこの順番になりませんが、やることは同じです。アジャイル開発の手法も参考にしてみてください。デザインの適応のタイミングは、プロジェクトの都合で後になることもあります。早いうちにデザインを当てていく方がアプリを構築している実感がわき、作業をするときのやる気が全然違います。

トップダウンでのアプリ構築手順（参考）

 1. DB設計
 2. 画面遷移の決定
 3. プロジェクト、MVCの作成
 4. デザインの適用
 5. 機能実装（テスト含む）
 6. デプロイ

#### (b) 例題

ここではタイムゾーンの設定を紹介します。機能を実装していく前に必ず行ってください。Railsの時刻のデフォルトはUTCです。  
このタイムゾーンをきちんと管理しないと、サーバーのタイムゾーンとの整合性が取れなかったり、海外向けサービスを考えている場合は、データ間で時差が生じて大変なことになります。  
テストを実行する場合にも開発者がハマりやすいポイントですので注意してください。  

設定は簡単です。 `config/application.rb` の中に次の1行を追加してください。  
`railsbasic`のアプリで試してみましょう。  

```rb
module Railsbasic
  class Application < Rails::Application
    config.time_zone = 'Tokyo' # 追加
  end
end
```

ちなみに、日本国内では `Osaka` と `Sapporo` も設定できます。configフォルダ内の設定を変更したので、サーバーを再起動すれば設定完了です。確認方法としては、 `rails console` でTime.zoneを呼び出してみて、意図した時刻オフセットがついていればOKです。


```sh
$ cd railsbasic
$ rails c
```

設定前（デフォルト）
```rb
irb(main):001> Time.zone
=> #<ActiveSupport::TimeZone:0x00007f08155b3af0
  @name="UTC",
  @tzinfo=#<TZInfo::DataTimezone: Etc/UTC>,
  @utc_offset=nil>
```

設定後（Tokyoの場合）
```rb
irb(main):001> Time.zone
=>
#<ActiveSupport::TimeZone:0x00007f0891b36f28
  @name="Tokyo",
  @tzinfo=#<TZInfo::DataTimezone: Asia/Tokyo>,
  @utc_offset=nil>
```

__【Timeクラス】__  
Timeクラスは、Rubyの標準ライブラリで提供されているクラスの一つであり、日付と時刻を表現するためのクラスです。Timeクラスは、UNIXエポックからの経過秒数で時刻を表現します。  
`zone`メソッド以外にも様々なメソッドがあるので試してみてください。  

以下は、Timeクラスの主な機能や使い方についての概要です。  

1. 現在の時刻の取得：
`Time.now`メソッドを使用して、現在の時刻を取得できます。
```rb
current_time = Time.now
```

2. 特定の時刻の生成：
`Time.new`メソッドを使用して、指定した年月日や時分秒で時刻を生成できます。
```rb
specific_time = Time.new(2024, 4, 2, 12, 30, 0)
```

3. 時刻の比較：
`Time`クラスでは、時刻の比較演算子（<, <=, >, >=, ==, !=）を使用して、時刻の大小を比較することができます。
```rb
past_time = Time.new(2023, 12, 25)
future_time = Time.new(2024, 1, 1)

puts past_time < future_time  # true
```

4. 時刻の演算：
`Time`クラスでは、+や-演算子を使用して時刻に加算や減算を行うことができます。加算や減算の単位は秒です。
```rb
current_time = Time.now
future_time = current_time + 60  # 現在の時刻から60秒後
```

5. 時刻の書式設定：
strftimeメソッドを使用して、時刻の書式を指定して表示することができます。
```rb
current_time.strftime("%Y-%m-%d %H:%M:%S")  # => "2024-04-02 15:30:00"
```


タイムゾーンの設定に関しては、以下の注意点があります。

1. タイムゾーンの選択：タイムゾーンの選択は、アプリケーションの利用者がいる地域や、サーバーがホストされている地域によって異なります。日本国内での開発や利用であれば、通常は'Tokyo'を選択しますが、国際的なサービスや分散型の開発チームであれば、他のタイムゾーンを選択することもあります。

2. データベースのタイムゾーン：アプリケーションのタイムゾーンを設定するだけでなく、データベースのタイムゾーンも適切に設定することが重要です。RailsではデフォルトでUTCが推奨されていますが、タイムゾーンの設定に合わせてデータベースのタイムゾーンも調整する必要があります。

3. 時間表示の統一：アプリケーション内での時刻の表示は、一貫性があることが重要です。表示する時刻がすべて同じタイムゾーンに変換されるようにするか、または明示的にその時刻がどのタイムゾーンであるかを表示するようにしましょう。


#### (c) 問題

ECサイトにタイムゾーンを設定しましょう。  
まずは新しく`ec_site`というアプリを新規作成してください。これからこのアプリを使って様々な機能を実装していきます。  

### 7.6.3 画面遷移とルーティングの設定

#### (a) 解説

画面遷移の検討、決定方法についてはUIやプロジェクトの進行にも関連します。ここでは簡単に触れるだけにしておきますが、プロジェクトの成功にとって重要な要素であることは覚えておきましょう。  

1. ユーザビリティの向上：ユーザビリティは、アプリケーションの成功に直結します。適切な画面遷移を設計することで、ユーザーがスムーズに操作できるようにします。例えば、同じ機能にアクセスするために複数の画面を経由する必要がある場合は、それを一つの画面にまとめるなどの工夫が必要です。  
例：ECサイトで商品一覧と詳細情報、カートへの追加などを1つの画面で行えるようにする。

2. 情報の整理と階層化：アプリケーションが提供する情報や機能を適切に整理し、階層化することも重要です。これにより、ユーザーが必要な情報に素早くアクセスできるようになります。画面遷移を設計する際には、この点にも注意を払いましょう。  
例：ECサイトでカテゴリごとに情報を整理し、ユーザーが関心のある商品を素早く見つけやすくする。

3. アクセシビリティの考慮: アクセシビリティは、すべてのユーザーがアプリケーションを利用できるようにするための重要な要素です。画面遷移や操作フローを設計する際には、異なる能力や状況のユーザーにも配慮した設計を心がけましょう。　　
例：ボタンなどをわかりやすく配置して操作を直感的にする。  


今回は以下のように、scaffoldをベースにした遷移を作成してください。このとき、各ページのURLはなるべくRailsのデフォルトに沿ったものを使用しましょう。共通の「レール」に乗った方法を使うことで、後々の仕様変更やバージョンアップに強くなり、開発の引き継ぎなどでもスムーズになります。

![画像](images/07-6-3-1.png)

まず、scaffoldで作成したControllerでは、デフォルトのアクションの遷移は次のとおりになっています。

- 登録：new -> create -> show
- 編集：edit -> update -> show

この遷移はControllerで簡単に変更することができます。操作性やデータ量等を考慮し、場合に応じて設定を変更していきましょう。

また、不要になったアクションなどは、面倒がらずに削除するようにしてください。削除しておかないと、後々メンテナンス性の低下につながります。削除対象として注意するものは次のとおりです。

 - Controllerのアクション
 - Viewのhtmlファイル
 - ルーティング
 - テスト
