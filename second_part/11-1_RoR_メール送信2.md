# Ruby on Rails：メール送信

## 目次
+ [例題](#例題)
  + [スケジュール登録アプリケーションの作成](#スケジュール登録アプリケーションの作成)
  + [Action Mailerクラスとメイラービューの作成](#action-mailerクラスとメイラービューの作成)
  + [Mailerクラスの編集](#Mailerクラスの編集)
  + [Viewの編集](#Viewの編集)
  + [Mailerの呼び出し](#Mailerの呼び出し)
  + [メールのプレビュー](#メールのプレビュー)
  + [ActionMailerの設定](#ActionMailerの設定)
  + [動作確認](#動作確認)

## 例題

簡単なToDoリストアプリケーションを作成し、ToDoの登録時に、メールを送信できるように実装します。

---

### スケジュール登録アプリケーションの作成

まず、例題としてRailsアプリケーションを作成し、その後、`scaffold`コマンドを使ってToDoタスクのCRUD機能を作成します。

1. **新しいRailsアプリを作成**  
   ```sh
   $ rails new MyToDoTask
   $ cd MyToDoTask
   ```

2. **`scaffold`コマンドでToDoタスクの管理機能を作成**  
   ```sh
   $ rails g scaffold ToDoTask title:string description:text alert_mail_address:string
   ```

3. **データベースの設定を反映**  
   ```sh
   $ rails db:migrate
   ```

---

### Action Mailerクラスとメイラービューの作成

次に、Mailerクラスとビューを作成します。`rails generate`コマンドを使って簡単に作成できます。

```sh
$ rails g mailer TodoTaskMailer registration_mail
```

このコマンドを実行すると、次のファイルが作成されます：

- `app/mailers/todo_mailer.rb`（Mailerクラス）
- `app/views/todo_mailer/registration_mail.text.erb`（テキストメール用ビュー）
- `app/views/todo_mailer/registration_mail.html.erb`（HTMLメール用ビュー）

`registration_mail`はToDo登録時に送信されるメールのメソッド名です。テキストとHTMLの2種類のフォーマットが作られるので、受信者の環境に応じて最適な形式でメールが表示されます。 

---

### Mailerクラスの編集

Mailerクラスに実際の送信処理を追加していきます。`registration_mail`メソッド内に最初からある不要なコードは削除します。

以下のコードを使って、メールの送信設定を行います。  

```rb
# app/mailers/todo_task_mailer.rb

class TodoTaskMailer < ApplicationMailer
  def registration_mail(todotask)
    @todotask = todotask
    mail to: todotask.alert_mail_address, subject: 'ToDo登録のお知らせ'
  end
end
```

- `mail`メソッドの`to`部分には、送信先のメールアドレス（`todotask.alert_mail_address`）が指定されます。  
- `subject`部分には、メールの件名（'ToDo登録のお知らせ'）が設定されます。  

これで、ToDoタスクの登録時に指定されたメールアドレスに通知が送信されるようになります。

---

### Viewの編集

メールの本文は、Viewで設定します。ここでは、ToDoのタイトルと内容を表示するようにします。

まずはHTML形式のビューを設定します。  

```html
<!-- app/views/todo_task_mailer/registration_mail.html.erb -->

<!DOCTYPE html>
<html>
  <head>
    <meta content='text/html; charset=UTF-8' http-equiv='Content-Type' />
  </head>
  <body>
    <h1><%= @todotask.title %></h1>
    <p><%= @todotask.description %></p>
  </body>
</html>
```

次に、テキスト形式のビューを設定します。

```html
<!-- app/views/todo_task_mailer/registration_mail.text.erb -->

<%= @todotask.title %>
===============================================
<%= @todotask.description %>
```

#### HTMLとテキスト形式の使い分け  
ActionMailerは、HTML形式とテキスト形式の2種類のフォーマットを使ってメールを送ります。受信者の環境に応じて、HTMLが表示できない場合はテキスト形式で表示されるようになります。  
これにより、受信者がどのメールクライアントを使っていても、最適な形式でメールが表示されます。  

---

### Mailerの呼び出し

Mailerクラスとメール本文が作成できたので、実際にメールを送るための処理を追加します。

ToDoタスクを登録した後にメールを送信するので、コントローラの`create`アクションで、DBに登録した後にメールを送るように設定します。

以下のコードを`create`アクションに追加します。  

```rb
# app/controllers/to_do_tasks_controller.rb

# POST /to_do_tasks
# POST /to_do_tasks.json
def create
  @to_do_task = ToDoTask.new(to_do_task_params)

  respond_to do |format|
    if @to_do_task.save
      # メール送信の処理を追加
      TodoTaskMailer.registration_mail(@to_do_task).deliver_now

      format.html { redirect_to @to_do_task, notice: 'To do task was successfully created.' }
      format.json { render :show, status: :created, location: @to_do_task }
    else
      format.html { render :new }
      format.json { render json: @to_do_task.errors, status: :unprocessable_entity }
    end
  end
end
```

#### ポイント
- `TodoTaskMailer.registration_mail(@to_do_task).deliver_now` で、ToDoタスクが保存された後にメールを送信します。  
- `deliver_now` はすぐにメールを送信する方法です（非同期で送信したい場合は `deliver_later` を使います）。  

これで、ToDoタスクが登録されると、登録者にメール通知が届くようになります。

---

### メールのプレビュー

Action Mailerには、メールを実際に送信する前にプレビューできる機能があります。これを使うことで、送信するメールの本文を確認することができます。

以下のコードを変更し、次のURLにアクセスしてプレビューを確認してみましょう：

```
http://localhost:3000/rails/mailers/todo_task_mailer/registration_mail
```

#### コードの変更

```rb
# test/mailers/previews/todo_task_mailer_preview.rb

# Preview all emails at http://localhost:3000/rails/mailers/todo_task_mailer
class TodoTaskMailerPreview < ActionMailer::Preview

  # Preview this email at http://localhost:3000/rails/mailers/todo_task_mailer/registration_mail
  def registration_mail
    # 以下のように変更
    TodoTaskMailer.registration_mail(ToDoTask.new(title:"テスト", description:"プレビュー テスト", alert_mail_address:'自身のメールアドレス'))
  end
end
```

- 上記のコードで、`registration_mail` メソッドがプレビューできるようになります。  
- メールの内容を確認するために、`ToDoTask.new`でダミーデータを使ってメールを生成しています。  

このURLにアクセスすると、実際に送信されるメールと同じ内容をプレビューとして確認できます。

<br>

---

### ActionMailerの設定

最後に、メール送信に必要な設定を行います。まずは開発環境用の設定を行い、その後、本番環境で使用する場合には別途設定が必要です。ここでは、Gmailを使った設定例を紹介します。

#### 開発環境設定 (`config/environments/development.rb`)  

```rb
# config/environments/development.rb

config.action_mailer.raise_delivery_errors = true
config.action_mailer.delivery_method = :smtp
config.action_mailer.smtp_settings = {
  address: 'smtp.gmail.com',
  port: 587,
  domain: 'gmail.com',
  user_name: ENV['MAIL_USER_NAME'],
  password: ENV['MAIL_PASSWORD'],
  authentication: 'plain',
  enable_starttls_auto: true
}
```

- **`user_name`** と **`password`** は、直接設定するのではなく、環境変数（`ENV`）を使います。これはセキュリティを高めるためです。

#### `.env` ファイルの作成

次に、環境変数を管理するために `.env` ファイルを作成します。

1. **`dotenv-rails`** をインストールします。

```rb
group :development, :test do
  gem 'dotenv-rails'
end
```

2. インストール後、以下のコマンドで `bundle install` を実行します。

```sh
$ bundle install
```

3. アプリのルートディレクトリに `.env` ファイルを作成し、以下のように自分の Gmail アドレスとパスワードを設定します。

```
MAIL_USER_NAME="sample@example.com"
MAIL_PASSWORD="pass0000"
```

#### `.gitignore` ファイルの確認

`.env` ファイルは Git に追加しないように `.gitignore` に記載されていることを確認します。

```
/.env*
!/.env*.erb
```

これで、ソースコードに重要な情報（ユーザー名やパスワード）が含まれないようになります。

#### 開発環境での設定（Cloud9）

Cloud9 などの開発環境では、次のように環境変数を設定できます。

```sh
$ export MAIL_USER_NAME="sample@example.com"
$ export MAIL_PASSWORD="pass0000"
```

#### 本番環境での設定（Heroku）

本番環境（Heroku）では、次のように環境変数を設定します。

```sh
$ heroku config:add MAIL_USER_NAME="sample@example.com"
$ heroku config:add MAIL_PASSWORD="pass0000"
```

---

### 動作確認

メール送信の設定が完了したので、実際にメールが届くか確認してみましょう。まずは、Gmailの設定を行います。

#### 1. Gmailの設定

まず、Gmailで2段階認証をオンにします。これに関しては、以下の記事を参考にしてください。

- [Gmailで2段階認証をオンにする方法](https://support.google.com/accounts/answer/185839?hl=ja&co=GENIE.Platform%3DDesktop)

#### 2. アプリログインパスワードの取得

2段階認証を有効にした後、アプリログインパスワードを取得します。これに関しては、次の記事を参考にしてください。

- [Gmailでアプリパスワードを設定する方法](https://support.google.com/mail/answer/185833?hl=ja)

#### 3. `.env` ファイルの設定

16桁のアプリパスワードを取得したら、以下のように `.env` ファイルを更新します。

```
MAIL_USER_NAME="your-email@gmail.com"
MAIL_PASSWORD="your-app-password"
```

#### 4. メール送信のテスト

設定が完了したら、Railsコンソールでメール送信の動作を確認します。

```sh
$ rails c
```

コンソールで以下を入力します。

```ruby
irb(main):001:0> test = ToDoTask.new(title:"テスト", description:"プレビュー テスト", alert_mail_address:'your-email@gmail.com')
irb(main):002:0> TodoTaskMailer.registration_mail(test).deliver
```

これで、指定したGmailアドレスにメールが送信されます。

#### 5. エラーの対処

`OpenSSL::SSL::SSLError`というエラーが発生することがあります。これは、SSL証明書の検証に関連したエラーです。この場合、以下のコードを追加して設定を変更します。

```rb
# config/environments/development.rb

require "active_support/core_ext/integer/time"

Rails.application.configure do
  # 他の設定内容
  config.action_mailer.raise_delivery_errors = true
  config.action_mailer.delivery_method = :smtp
  config.action_mailer.smtp_settings = {
    address: 'smtp.gmail.com',
    port: 587,
    domain: 'gmail.com',
    user_name: ENV['MAIL_USER_NAME'],
    password: ENV['MAIL_PASSWORD'],
    authentication: 'plain',
    openssl_verify_mode: 'none', # 追加
    enable_starttls_auto: true
  }
end
```

この設定を追加した後、再度メール送信を試みてください。

#### 6. 結果の確認

メールが無事に届いていれば、設定は完了です。自分のGmailに通知メールが届いていない場合は、設定を再度確認してみましょう。

---

これで、Gmailを使用したメール送信機能の設定が完了しました。