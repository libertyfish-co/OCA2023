# Ruby on Rails：メール送信

## 目次

+ [メール送信のプロトコルの概要](#メール送信のプロトコルの概要)
    + [ActionMailerとは？](#ActionMailerとは)
+ [メール送信の実装](#メール送信の実装)
    + [Mailerクラスを作成する](#Mailerクラスを作成する)
    + [メールの内容を作成](#メールの内容を作成)
    + [送信処理](#送信処理)

---

## メール送信のプロトコルの概要

メールを送信するには、通常 **SMTP** という仕組みを使います。SMTP（Simple Mail Transfer Protocol）は、インターネット上でメールを送るためのプロトコルです。SMTPを使ったメール送信の流れは以下のようになります。

1. **メールを組み立てる**  
   メールソフトやRailsアプリケーションが、送信者、受信者、タイトル、本文、添付ファイルなどの情報を作ります。

1. **送信者のサーバへ送信**  
   作成されたメールは、設定されたメールサーバに送られます。

1. **送信者サーバが認証**  
   送信者のメールサーバは、送信者が許可されたユーザーであるか確認し、確認が取れたらメールを受け取ります。

1. **受信者サーバに転送**  
   送信者サーバは、受信者のメールサーバにメールを転送します。

1. **受信者サーバが受け取り**  
   受信者のメールサーバは、送られてきたメールが正しい受信者のものであるか確認し、有効であれば受信者のアカウントにメールを保存します。

**POP（Post Office Protocol）** と **IMAP（Internet Message Access Protocol）** は、受信のために使われるプロトコルです。これらは、メールサーバからメールを取得するために使います。

---

### ActionMailerとは？

ここでは、例えば商品の購入後にメールを送信する機能を実装していきます。これを実現するのが **ActionMailer** という仕組みです。

**ActionMailer** は、Railsの組み込みの機能（gem）で、メールを送ったり受け取ったりするために使われます。メール送信に必要なクラスやメソッドを提供してくれるので、Railsアプリケーション内で簡単にメールを送信できます。

ActionMailerは、次のように動作します。

1. **Mailerクラスを作成**  
   メールを送るための設定や処理を定義するクラスを作ります。

1. **Viewを作成**  
   メールの内容を表示するためのテンプレート（HTMLやテキスト）を作ります。

これらは、通常のControllerとViewの関係に似ています。

<br>

---

## メール送信の実装

実際にメールを送信するには、次のステップを踏みます。

---

### Mailerクラスを作成する

まず、メールを送るための **Mailer** クラスを作成します。このクラスでは、メールの送信先や件名、本文などを設定します。

```ruby
class PurchaseMailer < ApplicationMailer
  def purchase_confirmation(user)
    @user = user
    mail(to: @user.email, subject: 'ご購入ありがとうございます！')
  end
end
```

---

### メールの内容を作成

メールの内容は、ActionMailerのViewで作成します。HTML形式でメールを送るため、`purchase_confirmation.html.erb`というファイルを作成し、メールの本文をHTMLで記述します。

```erb
<!-- app/views/purchase_mailer/purchase_confirmation.html.erb -->
<h1>ご購入ありがとうございます、<%= @user.name %>さん！</h1>
<p>ご注文内容を確認しました。</p>
```

--

### 送信処理

メール送信を行うためには、ControllerでMailを呼び出します。例えば、購入後にメールを送る場合、次のようにします。

```ruby
# 購入が完了した後のController
class PurchasesController < ApplicationController
  def create
    @user = current_user
    # 購入処理
    PurchaseMailer.purchase_confirmation(@user).deliver_now
  end
end
```

---

#### ポイント

- **SMTPプロトコル**は、メール送信時に利用される一般的なプロトコルで、送信者から受信者にメールを転送します。  

- **ActionMailer**を使うことで、Railsで簡単にメール送信ができるようになります。MailerクラスとViewを使って、送信するメールの内容や形式を管理します。  

- メール送信の際、**HTML形式**と**テキスト形式**が選べ、どちらもActionMailerで簡単に設定できます。  

- メール送信を実行するには、Controller内で`Mailer`を呼び出し、`deliver_now`を使って即座にメールを送信します。  


