## Ruby on Rails：ECサイトの開発 画像アップロード2

## 目次
+ [画像のリサイズ](#画像のリサイズ)
  + [ImageMagick](#ImageMagick)
  + [練習](#練習)

<br>

---

## 画像のリサイズ
**Active Storage**を利用して表示する画像のリサイズを行うために、**ImageMagick**を使用します。

---

### ImageMagick

**ImageMagick**は、画像のリサイズ、フォーマットの変換、画像加工、GIFアニメーションの作成など、さまざまな画像処理ができるツールです。

---

#### gemの追加

`Gemfile`に`gem 'image_processing'`を追加しましょう。もしコメントアウトされている場合は、そのコメントを解除してください。

`ImageProcessing`は画像のサイズを調整するための機能を提供する`gem`です。

`Gemfile`を変更した後、次のコマンドを実行して依存関係をインストールしましょう。

```sh
$ bundle install
```

---

#### モデルにリサイズするメソッドを定義
大きめの画像がアップロードされた場合でも、表示時に一定の大きさにリサイズされるようにします。  
Active Storageでは、アップロードされた画像はそのまま保存され、表示時にリサイズされます。  
画像の大きさを縦横300x300ピクセルに収めて表示するために、モデルにメソッドを追加します。

```rb
# app/models/user.rb
class User < ApplicationRecord
  # ユーザーがアップロードした写真を保持する
  has_one_attached :photo

  # サムネイル用の画像を縦横300x300ピクセルにリサイズする
  def thumbnail
    # photo.variantで画像を加工し、resize_to_fillで指定したサイズにリサイズ
    photo.variant(resize_to_fill: [300, 300])
  end
end
```

---

#### リサイズされた画像の確認 

1. リサイズした画像を表示できるように、ビューを修正します。  
    追加したリサイズメソッドを利用して、画像を表示できるようにビューを更新します。ここでは、元の画像とリサイズ後の画像を比較できるように、`@user.thumbnail`を使って表示する処理を追加します。

    ```html
    <!-- app/views/users/show.html.erb -->
    ・
    ・
    <p>
      <strong>Photo:</strong>
      <% if @user.photo.attached? %>
        <!-- 元の画像を表示 -->
        <%= image_tag @user.photo %>
        <!-- リサイズ後の画像（サムネイル）を表示 -->
        <%= image_tag @user.thumbnail %>
      <% end %>
    </p>
    ・
    ・
    ```

1. ブラウザで`show`ページを開いて、画像を確認します。  
   アップロードした画像が指定されたサイズ（300x300ピクセル）で表示されれば、設定は正しく完了です。

---

### 練習 
新しく`photo_post`アプリを以下の条件で作成してください。  
- `User`モデルと`Post`モデルを実装してください。
- `User`モデルでは名前(20文字以内)、アイコン画像を設定できます。
- `Post`モデルではタイトル(20文字以内)、投稿内容(200文字以内)、画像の投稿ができます。
- ユーザーを新規作成するときはアイコンを設定できます。
- ユーザーはログイン後にマイページへ遷移します。
- ユーザーはマイページでは以下画面へ遷移するボタンもしくはボタンがあります。
    - 投稿一覧画面
    - ユーザー編集画面
    - ログアウトボタン
- ユーザー編集画面では以下の変更ができます。
    - 名前の変更
    - アイコンの変更
- 新規投稿ページはタイトル、投稿内容、画像が入力できます。(今回はユーザーと投稿を紐づける必要はありません)
- 新規投稿後は投稿一覧ページへ遷移します。
- 一覧ページの画像のサイズは300x300にしてください。
- 一覧ページから投稿のタイトルを押下すると該当の投稿詳細ページへ遷移します。
- 詳細ページの画像のサイズは600x600にしてください。