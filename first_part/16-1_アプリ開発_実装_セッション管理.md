# アプリ開発　実装　セッション管理

## 目次
- [セッション管理](#セッション管理)
  - [セッション管理とは](#セッション管理とは)
  - [セッション・Flashの使用](#セッションflashの使用)
  - [カート機能の実装](#カート機能の実装)


---

## セッション管理
この章では、セッション管理について学びます。  

### セッションとは  
実装の前にセッションについて簡単に説明します。  
Web アプリケーションでは、特定のユーザーがどのような状態（ステート）にあるか追跡することがあります。例としてショッピングサイトの買い物カゴ、現在ログインしているユーザーの ID などが挙げれらます。  
  
しかし、HTTP は基本的にステートレスプロトコルのため、カート情報やユーザ情報を次の HTTP リクエストまで保持しておくことができません。（例：カートの中身、ユーザー情報）  
  
そのため、これらの有効な情報を保持してステートフルな通信を実現するため、**セッション**を利用します。  
デフォルトではセッション情報はブラウザの Cookie(クッキー)に保存されます。アプリケーション層のセッションデータとブラウザのセッションデータの照合をすることで、ステートフルを実現しています。  
  
>ステートレス：前の通信を引き継がない（状態（情報）を保持できない）
>ステートフル：前の通信を引き継ぐ（状態を保持できる）
  
---
  
#### Rails のセッション
Railsアプリケーションではユーザごとにセッションが設定されます。また、ユーザーが既にアプリケーションを使用中であれば、既存のセッションを読み込みます。  
セッションの中に前のリクエストの情報を次のリクエストでも利用できるよう、小さなデータを保存することができます。  
  
セッションデータの保存先には幾つか種類がありますが、デフォルトではクライアント（ユーザー）側のブラウザクッキーに保存する方法が取られます。なお、クッキーは暗号化され、保存形式もハッシュを模しております。
  
---

#### セッションストア

Rails には以下のようなセッションストアが用意されており、ストレージを選択してセッション情報を保存することができます。デフォルトでは `CookieStore` が使われます。  
Rails の推奨セッションストアである`CookieStore`はセッションを利用するための準備が不要であり、データが暗号化されているので安全に利用できます。　　

__セッションストア一覧__

| ストレージ | 概要 |
|---|---|
| `ActionDispatch::Session::CookieStore` | すべてのセッションをクライアント側のブラウザのクッキーに保存する |
| `ActionDispatch::Session::CacheStore` | データを Rails のキャッシュに保存する |
| `ActionDispatch::Session::ActiveRecordStore` | Active Record を用いてデータベースに保存する (activerecord-session_store gemが必要) |

---

#### セッション使用時の注意事項

- __秘密情報を保持させない__
デフォルト設定でのセッションデータはクッキーに保存されます。そのため、暗号化で改ざん防止機構はついていますが、内容を確認することができてしまいます。秘密情報は保持しないようにしましょう。  
  
- __データは小さく__
クッキーは 4KB 弱という容量制限があるため、セッションに大量のデータを保存できません。Rails でのセッションの使い方としては、入れるデータをユーザーの ID や flash などの軽いデータにすることが望ましいです。  
  
----
  
**用語解説**
- __Cookie（クッキー）__  
Web サイトを訪問した際、Web ブラウザの中に一時的に保存される小さなテキストファイルです。セッション情報を保存する先の1つ。

<details>
<summary>コラム：セキュリティの注意点</summary>

セキュリティに関しては、新しい欠陥（**セキュリティホール**）が見つかったり、それを利用して秘密情報を盗む手順が考えられたりします。プログラムの作り方によっては、思いも寄らないセキュリティホールを作ってしまったり、セッションの中に秘密情報を記録してしまったりすることがあります。  
Rails でのセキュリティに対する記述の仕方や考え方を理解するため、また自分の知識を再確認するためにも以下のサイトを一読されることをお勧めします。  
  
Rails セキュリティガイド  
https://railsguides.jp/security.html
  
</details>

---
  
### セッション・Flashの使用

#### セッションの使用
ここでセッションの使用方法を確認してみましょう。今回はユーザーログインの場面で見てみます。セッションへのアクセスは`session`メソッドを使用します。また、セッションは「キー」と「値」のペアでデータを保持します。  

- __セッションにデータを保持させる__
    ユーザーログイン時に、セッションを使ってユーザーIDを保存する方法です。
    ユーザーが名前とパスワードを使ってログインしたとき、そのユーザーのIDをセッションに保存する処理は以下のようになります。  
    
    ```rb
    def create
      current_user = User.find_by(name: params[:name], password: params[:password])
      session[:user_id] = current_user.id
    end
    ```

    このコードでは、まず `User.find_by`でデータベースから名前とパスワードに一致するユーザーを探し、そのユーザーのIDを`session[:user_id]`に保存しています。これによって、ログインしたユーザーのIDがセッションに保存され、他のページに遷移後もそのIDを使ってユーザーを認識できるようになります。  
  

- __セッションのデータを削除する__  
    セッションから特定のデータを削除したい場合、`delete`メソッドを使います。引数に削除したいキー（この場合は`user_id`）を指定します。

    ```rb
    def destroy
      session.delete[:user_id]
    end
    ```
    このコードでは、session.delete(:user_id)を使ってセッションから`user_id`を削除しています。ログアウト処理の際にユーザーIDをセッションから削除することで、次回のリクエスト時にそのユーザーを認識できなくなります。  
  
  
- __セッションの内容を全てリセット__  
    セッションの中身をすべてリセットするには、reset_sessionメソッドを使います。このメソッドを呼び出すと、セッション内のデータがすべて削除されます。  
    ```rb
    def reset_session
      session.reset_session
    end
    ```
    上の記述でセッション全体がリセットされ、ユーザーのログイン状態やその他の情報が消去されます。特にログアウト後やユーザーのセッションを完全に終了させたい場合に使用します。  

---

### Flash

セッションに加えて Rails では **flash** という仕組みも使って、ユーザーにメッセージを表示することができます。flash は、セッションと同様にデータを一時的に保存しますが、リクエストを一回限りで表示するために使用される点が特徴です。

例えば、ログインやログアウト、ユーザー登録などの処理後に、ユーザーに対して「成功しました」や「エラーが発生しました」などのメッセージを表示する際にflashがよく利用されます。

#### flashの使用例
flash は、セッションの一部として次のリクエストでだけ表示されるメッセージを保持します。つまり、メッセージはリダイレクトや画面遷移後に表示されますが、リクエストが終わると自動的にクリアされます。これを活用することにより処理後、ユーザーに処理のフィードバックを渡すことができます。

例えばログアウト処理後に「ログアウトしました」と表示する場合、次のように記述します。

```rb
class SessionController < ApplicationController
  def destroy
    # セッションからユーザーIDを削除
    session.delete(:current_user_id)
    
    # Flashにメッセージを設定
    flash[:notice] = "ログアウトしました"
    
    # ルートURLにリダイレクト
    redirect_to root_url
  end
end
```
このコードではログアウト処理を行った後、`flash[:notice]`に「ログアウトしました」というメッセージを保存し、次のリクエスト時にこのメッセージが表示されるようにしています。flash は次の画面でのみ表示され、その後は自動的に削除されるため、**ユーザーに一度きりのフィードバックを与えるのに非常に便利**です。

---

#### FruitShopにセッションの保存と削除の機能を追加する

ECサイトでは `devise` を利用してログイン状態を管理するようにしています。そこで、`Devise` の機能を利用しながら、ログイン、ログアウトでセッションに任意の値を保存、削除できるようにしてみましょう。

`config/routes.rb`
```rb
Rails.application.routes.draw do
  ・
  ・
  # Deviseの処理をSessionsControllerで処理させるようにする
  devise_for :users, controllers:  {
    sessions: 'users/sessions'
  }
end
```
  
`app/controllers/users/sessions_controller.rb`  
```rb
class Users::SessionsController < Devise::SessionsController
  # before_action :configure_sign_in_params, only: [:create]

  # GET /resource/sign_in
  def new
    # 継承元のDeviseの処理をそのまま実行する
    super
  end

  # POST /resource/sign_in
  def create
    # ログインが成功したら、継承元のDeviseのcreateを実行後、sessionに値を保存する
    super
    session[:user_id] = current_user.id
  end

  # DELETE /resource/sign_out
  def destroy
    # ログアウトしたら、sessionの値を削除後、継承元のDeviseのdestroyを実行する
    session.delete(:user_id)
    super
  end

  # protected

  # If you have extra params to permit, append them to the sanitizer.
  # def configure_sign_in_params
  #   devise_parameter_sanitizer.permit(:sign_in, keys: [:attribute])
  # end
end
```

---
  
**ポイント**
 - **セッションにデータを保存**：`session[:キー] = 値` の形式でデータを保存
   
 - **セッションのデータを削除**：`session.delete(:キー)` を使用
  
 - **セッション全体をリセット**：`session.reset_session` を使用

---

### カート機能の実装
続いて作成中のFruitShopにカート（買い物かご）機能を実装していきましょう。  
  
セッションを管理するテーブルとして`Cart`テーブル、カート内の商品明細を管理する`CartItem`テーブルを作成しましょう。次のコマンドを実行してください。  
```bash
rails g model cart
rails g model CartItem cart:references product:references quantity:integer price:integer
```

作成したマイグレーションファイルに対して、追記を行います。
`db/migrate/xxxxxxxxxxxxxx_create_cart_items.rb`
```rb
class CreateCartItems < ActiveRecord::Migration[7.1]
  def change
    create_table :cart_items do |t|
      t.references :cart, null: false, foreign_key: true
      t.references :product, null: false, foreign_key: true
      t.integer :quantity, null: false, default: 0          # 追加箇所
      t.integer :price, null: false, default: 0             # 追加箇所

      t.timestamps
    end
  end
end
```

追記が完了したらターミナルで `rails db:migrate` を実行しましょう。  
  
  
続いて`Cart`コントローラーを作成します。次のコマンドを実行してください。  
```bash
rails g controller carts
```
  
次にモデルの関連付けを行っていきます。  
まずは今回使用するパスの設定です。カートに商品を追加したり、カートの確認、カートを空にする処理が今回は必要なため、以下のように設定しましょう。    

`config/routes.rb` 
```rb
Rails.application.routes.draw do

  # 省略

  resources :carts, only: [:show ,:destroy] # カートの詳細、カートを空にする
  resources :cart_items, only: [:create]    # カート内に商品を追加

  # 省略

end
```

続いてアソシエーションの定義を行います。商品とカートを繋ぐため、`Product`テーブル、`Cart`テーブル、`CartItem`テーブルを編集していきます。以下のように追記しましょう。    

`app/models/product.rb`
```rb
class Product < ApplicationRecord
    validates :name, presence: true
    validates :price, presence: true

    has_many :cart_items                  # 商品は複数のカートアイテムと関連している（1対多の関係）
    has_many :carts, through: :cart_items # 商品は中間テーブルを通じて複数のカートと関連している（多対多の関係）
end
```
  
`app/models/cart.rb`
```rb
class Cart < ApplicationRecord
    has_many :cart_items                     # カートは複数のカートアイテムと関連している（1対多の関係）
    has_many :products, through: :cart_items # カートは中間テーブルを通じて複数の商品と関連している（多対多の関係）

    # 商品が既にあれば取得、なければ新規でCartItemオブジェクトを生成して返す
    def add_product(product_id)
      cart_items.find_or_initialize_by(product_id: product_id)
    end

    # カート内の合計金額を計算する
    def total_price
      cart_items.to_a.sum {|item| item.total_price}
    end
    
    # カート内の合計個数を計算する
    def total_quantity
      cart_items.to_a.sum {|item| item.quantity}
    end
end
```

これで商品とカートの結びつけができました。  
  
続いてカートへ商品を追加、カートの中身の確認、カートを空にする処理をそれぞれ実装するため、各コントローラーを編集していきます。以下のように追記していきましょう。  
  
`app/controller/cart_items_controller.rb`
```rb
class CartItemsController < ApplicationController
  # 追加　ここから
  # カートアイテムを作成するアクション（商品をカートに追加）
  def create
    # 現在のカートを取得
    cart = current_cart

    # 商品IDから、カートに追加する商品をデータベースから取得
    product  = Product.find(params[:product_id])

    # カートに商品を追加（add_productメソッドを使用して、
    # 既にカートに商品があればその商品を、無ければ新たにCartItemを生成）
    @cart_item = cart.add_product(product.id) 
      
    # 処理の結果によってHTMLレスポンスを返す
    respond_to do |format|
      # カートアイテムが正常に保存できた場合
      if @cart_item.save
        # 商品一覧ページにリダイレクト
        format.html { redirect_to products_path }
      else
        # 商品ページにリダイレクト（エラーが発生した場合）
        format.html { redirect_to product_path(product.id) }
      end
    end
  end
  # 追加　ここまで
end
```

`app/controller/carts_controller.rb`
```rb
class CartsController < ApplicationController
  # 追加　ここから
  before_action :current_cart
    
  def show
    # パラメータで指定されたカートIDを使って、カートを取得
    @cart = Cart.find(cart_params)
    # カートに関連するすべてのCartItemを取得
    @cart_items = @cart.cart_items 
  end

  # 買い物かごを空にする処理
  def destroy
    session[:cart_id] = nil     # セッションの cart_id を空にする
    redirect_to products_path   
  end
  # 追加　ここまで

  private

  def cart_params
    params.require(:cart).permit(:id)
  end

end
```

追加を終えると処理が実装されました。

---

最後に画面を作成していきます。  
新規作成も含めて、以下のように画面を作成・編集をしていきます。  

__商品一覧ページの編集__(`app/views/products/index.html.erb`)  
```html
<% @products.each do |product| %>
  <div>
    <p>商品名: <%= product.name %></p>
    <p>価格: <%= product.price %>円</p>
    <p>説明: <%= product.description %></p>
  </div>
<% end %>

<!-- 画面に遷移するためのリンク -->
<% if session[:cart_id] %>
  <%= link_to '買い物かごを見る', cart_path(session[:cart_id]) %>
<% end %>
```
- __商品一覧表示__  
  - `@products.each do |product|` で、データベースから取得した商品情報をループして表示します。各商品について、商品名、価格、説明を表示します。  
- __買い物かごのリンク__  
  - `session[:cart_id]` が存在する場合、つまりカートが作成されている場合に「買い物かごを見る」リンクを表示します。リンクをクリックすると、現在のカート詳細ページに遷移します。  
  
  
__カート詳細ページの作成__(`app/views/carts/show.html.erb`) ← 新規作成
```html
<% @cart_items.each do |cart_item| %>
  <% product = cart_item.product %>
  <div>
    <p><%= product.title %></p>
    <p><%= cart_item.quantity %>個</p>
    <p>
      <%= cart_item.total_price %>
      <span>円 (税込)</span>
    </p>
  </div>
<% end %>
  
<div>
  <p>
    注文数： 
    <%= @current_cart.total_quantity %>
    <span>個</span>
  </p>
  <p>
    合計金額：
    <%= @current_cart.total_price %>
    <span>円 (税込)</span>
  </p>
</div>


<% if @cart_items.count == 0 %>
  買い物かごには何も入っていません。
<% else %>
  <%= link_to '買い物かごを空にする', @cart,
   data: { "turbo-method": :delete, "turbo-confirm": '買い物かごの中身をすべて削除してもいいですか？' } %> >
<% end %>  
```

- __カートアイテムの表示__  
  - `@cart_items.each do |cart_item|` で、カートに入っている各アイテムをループして表示します。各アイテムに対して、商品タイトル、数量、合計金額を表示します。  

- __注文数と合計金額__  
  - カート内の商品の合計数量と合計金額を表示します。これには、`@current_cart.total_quantity` と `@current_cart.total_price` を使用します。  

- __カートが空の場合のメッセージ__  
  - カートに商品が何も入っていない場合、「買い物かごには何も入っていません」と表示します。  

- __買い物かごを空にするリンク__
  - カートにアイテムが入っている場合、「買い物かごを空にする」リンクを表示します。リンクをクリックすると、カート内のすべてのアイテムが削除される確認ダイアログが表示されます。  

これで、カート機能が実装されました。商品一覧ページでは商品情報を表示し、カート詳細ページではカートに追加した商品を確認・削除することができます。  
実際に動かして確認してみましょう。動作確認後、問題がなければこれでカート機能が完成です。  

このように、カートの表示、アイテムの追加・削除機能を画面に組み込み、ユーザーがカートに商品を追加して、確認・購入できるようにしています。  