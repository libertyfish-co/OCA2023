# アプリ開発　実装　ユーザー認証機能

## 目次
- [ユーザー認証機能](#ユーザー認証機能)
  - [ユーザー認証機能のメリット](#ユーザー認証機能のメリット)
  - [devise](#devise)
  - [FruiteShopにdeviseをインストール](#fruiteshopにdeviseをインストール)
  - [ユーザー認証機能の実装](#ユーザー認証機能の実装)

---

## ユーザー認証機能
この章では、ユーザーの認証機能について学びます。Web アプリケーション開発ではとても重要な機能ですので、しっかりと身に着けていきましょう。  

### ユーザー認証機能のメリット  
今現在、皆さんがウェブ上に存在するサービスを利用しようとした場合、アカウント登録やログインを行っていると思います。  
ユーザー認証を実装することで、様々なメリットが存在するからです。  
例えば、今回作成していくFruiteShopアプリのようなECサイトで考えると以下のような点が挙げられます。  

- __顧客情報の集約__  
顧客の情報（例：年齢、性別、購買履歴）を集約し、管理することができます。これによって顧客の好みや行動パターンを把握し、ターゲティングされたマーケティング戦略を展開することができます。  
  
- __パーソナライズされたサービス提供__  
顧客ごとに異なるサービスや特典を提供することができます。例えば、過去の購買履歴や興味関心に基づいて商品のレコメンデーションを行ったり、特定のユーザーに割引クーポンを提供することが可能です。  
  
- __セキュリティの向上__  
顧客の個人情報（例：住所、支払い情報）を安全に保管することができます。また、アカウントごとにアクセス権を管理することで、不正なアクセスや情報漏洩を防止することができます。  
  
- __顧客満足度の向上__  
顧客が注文履歴を追跡したり、配送状況を確認したりすることができます。これによって顧客の利便性が向上し、顧客体験が向上します。  
  

他にも様々なメリットが存在しますが、ユーザー認証機能を実装することです。

----

### devise
今回はFruiteShopに Gem を使ってユーザー認証機能を実装していきます。使う Gem は以前学んだ「Gemの機能」に出てきていました **devise** です。
実装する前に1度、簡単に説明していきます。  
  
- **devise**とは
devise は Rails アプリケーションに認証機能を簡単に実装してくれる Gem であり、認証機能を追加するための Gem の中で一番使用されています。  
devise を使うことでユーザー承認やパスワードのリセット、セッション管理などの機能を迅速かつ安全に実装することができます。
下の表に記載している10のモジュールで構成されています。  

|モジュール名|説明|
|---|---|
|Database Authenticatable|ログインのためのパスワードをデータベースに暗号化して保存する。|
|Omniauthable|OmniAuthをサポートする|
|Confirmable|確認フロー中にメールを送信し、サインインの際にアカウントが確認済みか否かをチェックする|
|Recoverble|パスワードを忘れた際にパスワードをリセットし、再登録用のURLをメールで送信する|
|Registerable|ログインするためのアカウントを登録する|
|Rememberable|ログイン状態を保持する|
|Trackable|ログインした回数や日時、IPアドレスなどを保存する|
|Timeoutable|一定期間操作がない場合に、自動的にログアウトする|
|Validatable|メールアドレスとパスワードのバリデーションを設定する|
|Lockable|一定回数ログインに失敗した場合、そのアカウントをロックする| 

今回は上記の機能全てを詳しく説明できないので、詳しく知りたい方は下記を参照してみてください。

https://github.com/plataformatec/devise/wiki

---

### FruiteShopにdeviseをインストール
それでは、実際にFruiteShopアプリにユーザー認証機能を実装していきます。  

__deviseの導入__  
まず devise を導入していきます。  
FruiteShopアプリを開いたら、Gemfile を開いて最後の1行に下のように追記しましょう。  
ただ、この時点では Gemfile という設計書に書いただけで、インストールされていないことに注意しましょう。  

__Gemfile__
   ```rb
   source "https://rubygems.org"

   # 省略
 
   gem 'devise'
   ```

上記を行ったら、再度`bundle install`をターミナルで実行して、完了後にターミナルで下記のコマンドを実行します。  
devise の場合は、 Gem をインストールした後に改めてインストールの手順が必要となりますので、覚えておきましょう。
     
   ```bash
   rails g devise:install
   ```
   
完了すると以下のように表示されます。

   ```bash
      create  config/initializers/devise.rb
      create  config/locales/devise.en.yml
   ===============================================================================

   Depending on your application's configuration some manual setup may be required:

   1. Ensure you have defined default url options in your environments files. Here
       is an example of default_url_options appropriate for a development environment
       in config/environments/development.rb:

       config.action_mailer.default_url_options = { host: 'localhost', port: 3000 }

       In production, :host should be set to the actual host of your application.

       * Required for all applications. *

   2. Ensure you have defined root_url to *something* in your config/routes.rb.
       For example:

       root to: "home#index"
        
       * Not required for API-only Applications *

   3. Ensure you have flash messages in app/views/layouts/application.html.erb.
       For example:

       <p class="notice"><%= notice %></p>
       <p class="alert"><%= alert %></p>

       * Not required for API-only Applications *

   4. You can copy Devise views (for customization) to your app by running:

       rails g devise:views
        
       * Not required *

    ===============================================================================
   ```  

内容の説明としては次のようになります。

| 該当箇所 | 説明 |
|---|---|
| create | config 内に devise 関連のファイルを作成しています。 |
| 1. デフォルトの URL オプションの設定 | 開発環境や本番環境などに応じて、アプリケーションの URL オプションを設定します。開発環境の例が記載されており、ポート番号やホスト名などが含まれます。|
| 2. root_url の定義 | アプリケーションのルート URL を設定します。これは、ルーティングの設定に関連しています。 |  
| 3. フラッシュメッセージの設定 | ユーザーに通知を表示するためのフラッシュメッセージをレイアウトに追加します。 |
| 4. devise の View のコピー | カスタマイズや変更が必要な場合、devise の View をアプリケーションにコピーします。 |


これで devise の設定ファイルの作成が完了し、使用する準備が整いました。

--- 

#### ポイント

 - __ユーザー認証__
   ユーザー認証は Web アプリケーションに機能実装することで、顧客情報の集約、セキュリティの向上など様々なメリットがあります。

 - __devise__  
   devise は Rails アプリケーションに認証機能を簡単に実装してくれる Gem であります

 - __devise の導入__  
   devise を使用するためには、Gem のインストール後に改めて **devise 自体のインストールが必要**です。  

#### 用語解説

 - __フラッシュメッセージ__  
   ユーザーに対して一時的な通知を表示するための機能です。
   処理を行った時に「処理結果は成功しました（または失敗しました）」というような情報を知らせるために使用します。

---

### ユーザー認証機能の実装
ここからユーザー認証機能の実装を行っていきます。1つずつ順に説明していきます。  

#### ユーザーModel
今回はユーザー情報として「ユーザー名」「メールアドレス」「パスワード」を登録するため、まずはモデルから用意していきます。  

devise を利用するとユーザーテーブルを自動的に作成してくれます。
devise を使ってモデルを作成するときは独自のルールに従って作成します。  
ただ、ルールといっても難しいものでは無く、今まで使っていたコマンドを次のように変更するだけです。  

```bash
# devise を使わない場合
rails g model User
rails g scaffold User

　　　　↓

# devise を使う場合
rails g devise User
```
`rails g devise User`を行って、ファイルが正しく作成されるとターミナルで次のように出ます。

```bash
invoke  active_record
create    db/migrate/xxxxxxxxxxxxxx_devise_create_users.rb
create    app/models/user.rb
invoke    test_unit
create      test/models/user_test.rb
create      test/fixtures/users.yml
insert    app/models/user.rb
 route  devise_for :users
```
これで、「User」という名のモデルと、users テーブル用のマイグレーションファイルが作成されました。

- User モデル（ユーザ情報を操作する）
- users テーブルのマイグレーションファイル（ユーザ情報を保存する）

ここで作成された Model ファイルを確認してみましょう。  
app/models フォルダの user.rb も自動作成されて、User モデルが定義されています。  
このモデルには devise で利用する機能が記述されています。  

__app/models/users.rb__
```rb
class User < ApplicationRecord
  # Include default devise modules. Others available are:
  # :confirmable, :lockable, :timeoutable, :trackable and :omniauthable
  devise :database_authenticatable, :registerable,
         :recoverable, :rememberable, :validatable
end
```

「:database_authenticatable, :registerable,」のように、devise の後ろに :（コロン）で始まる部分が devise の機能名です。今回利用するものは下記の5つです。  

| 機能名 | 説明 |
|---|---|
| database_authenticatable | DB上のパスワードの正確性を検証 |
| registerable |ユーザー登録、編集、削除機能を作成 |
| trackable | ログイン回数やログイン時間など、ユーザー情報を保存 |
| rememberable | ログインユーザーの情報を保存 |
| validatable | email のフォーマットなどのバリデーション |

デフォルトの状態から trackable を有効化しましょう。反対に recoverable をコメントアウトしましょう。
以下のようにできていればOKです。

__app/models/users.rb__
```rb
class User < ApplicationRecord
  # Include default devise modules. Others available are:
  # :confirmable, :lockable, :timeoutable, :recoverable and :omniauthable
  devise :database_authenticatable, :registerable,
         :trackable, :rememberable, :validatable
end
```

続いてマイグレーションファイルを確認していきましょう。
マイグレーションファイルは、db/migrate フォルダ内にある 年月日時分秒_devise_create_users.rbファイルです。

__db/migrate/年月日時分秒_devise_create_users.rb__
```rb
# frozen_string_literal: true

class DeviseCreateUsers < ActiveRecord::Migration[7.1]
  def change
    create_table :users do |t|
      ## Database authenticatable
      t.string :email,              null: false, default: ""
      t.string :encrypted_password, null: false, default: ""

      ## Recoverable
      t.string   :reset_password_token
      t.datetime :reset_password_sent_at

      ## Rememberable
      t.datetime :remember_created_at

      ## Trackable
      # t.integer  :sign_in_count, default: 0, null: false
      # t.datetime :current_sign_in_at
      # t.datetime :last_sign_in_at
      # t.string   :current_sign_in_ip
      # t.string   :last_sign_in_ip

      ## Confirmable
      # t.string   :confirmation_token
      # t.datetime :confirmed_at
      # t.datetime :confirmation_sent_at
      # t.string   :unconfirmed_email # Only if using reconfirmable

      ## Lockable
      # t.integer  :failed_attempts, default: 0, null: false # Only if lock strategy is :failed_attempts
      # t.string   :unlock_token # Only if unlock strategy is :email or :both
      # t.datetime :locked_at


      t.timestamps null: false
    end

    add_index :users, :email,                unique: true
    add_index :users, :reset_password_token, unique: true
    # add_index :users, :confirmation_token,   unique: true
    # add_index :users, :unlock_token,         unique: true
  end
end
```

利用するモジュールに必要なカラムが記載されています。
今回利用する4つのモジュールの内、Trackable のみコメントアウトされているため、＃を外します。  
また、devise の用意するテーブルですとデフォルトではユーザー名を保存するカラムはありません。保存のカラムを追加しましょう。

__db/migrate/年月日時分秒_devise_create_users.rb__
```rb
# frozen_string_literal: true

class DeviseCreateUsers < ActiveRecord::Migration[7.1]
  def change
    create_table :users do |t|
      ## Database authenticatable
      t.string :email,              null: false, default: ""
      t.string :encrypted_password, null: false, default: ""
      t.string :name                                         # 追加　名前用カラム

      ## Recoverable
      t.string   :reset_password_token
      t.datetime :reset_password_sent_at

      ## Rememberable
      t.datetime :remember_created_at

      ## Trackable
      t.integer  :sign_in_count, default: 0, null: false    # #を外す
      t.datetime :current_sign_in_at                        # #を外す
      t.datetime :last_sign_in_at                           # #を外す
      t.string   :current_sign_in_ip                        # #を外す
      t.string   :last_sign_in_ip                           # #を外す

      ## Confirmable
      # t.string   :confirmation_token
      # t.datetime :confirmed_at
      # t.datetime :confirmation_sent_at
      # t.string   :unconfirmed_email # Only if using reconfirmable

      ## Lockable
      # t.integer  :failed_attempts, default: 0, null: false # Only if lock strategy is :failed_attempts
      # t.string   :unlock_token # Only if unlock strategy is :email or :both
      # t.datetime :locked_at


      t.timestamps null: false
    end

    add_index :users, :email,                unique: true
    add_index :users, :reset_password_token, unique: true
    # add_index :users, :confirmation_token,   unique: true
    # add_index :users, :unlock_token,         unique: true
  end
end
```

作業が終わったら、ターミナルでマイグレーションを実行しましょう。
```bash
rails db:migrate
```

Modelの準備は一旦ここまでです。  

--- 

#### Routing
続いて Routing を設定していきましょう。devise で Model を作成したことで、 configフォルダ内の routes.rb ファイルに自動追加されています。  

__routes.rb__
```rb
Rails.application.routes.draw do
  devise_for :users # この部分
  # Define your application routes per the DSL in https://guides.rubyonrails.org/routing.html

  # Reveal health status on /up that returns 200 if the app boots with no exceptions, otherwise 500.
  # Can be used by load balancers and uptime monitors to verify that the app is live.
  get "up" => "rails/health#show", as: :rails_health_check

  # Defines the root path route ("/")
  # root "posts#index"
end
```

devise_for :users は、devise を使用する際に URL として users を含むことを示しています。ターミナルで`rails routes`を行うと次の部分が追加されています。  

<img src="images/ユーザー認証機能/devise_routes.png" >
