<details open>
<summary>仮置き、コード全容</summary>

```ruby
# 定数管理クラス
class Constants
  # ステータス
  HP_ZERO = 0           # HP0定義
  ATK_VARIATION = 3  # こうげき力のブレ幅

  # 行動選択
  CHOICE_ATK = 1  # こうげき
  CHOICE_ESC = 2  # 逃げる

  # こうげきタイプ
  ATK_TYPE_NORMAL = 1  # 通常
  ATK_TYPE_MAGIC = 2   # 魔法こうげき
  
  # 書き出し間隔(秒)
  DISP_INTERVAL = 1
end

# 各種表示メッセージを管理するクラス
class Message
  # 名前の入力をユーザーに求める
  def self.entr_nm
    "↓勇者の名前を入力してください↓"
  end

  # ゲーム開始
  def self.gm_start
    "\n◆◆◆ モンスターが現れた！ ◆◆◆"
  end

  # ターン数
  def self.gm_turn(turn)
    "\n=== ターン #{turn} ==="
  end

  # キャラクターのステータス
  def self.stts(chrct)
    mark = chrct.alive ? "・" : "×"   # マーカー（生存:死滅）
    nm = chrct.nm                     # 名前
    hp = chrct.hp                     # HP
    atk_pwr = chrct.atk_pwr           # こうげき力

    "#{mark}【#{nm}】 HP：#{hp} こうげき力：#{atk_pwr}"
  end

  # 操作
  def self.act_choice(hero)
    nm = hero.nm                 # 名前
    atk = Constants::CHOICE_ATK  # こうげきの値
    esc = Constants::CHOICE_ESC  # 逃げるの値

    "\n#{nm} のターンです。\n↓行動を選択してください。↓\n【#{atk}】こうげき\n【#{esc}】逃げる"
  end

  # 無効な選択肢が入力された
  def self.inv_choice
    "無効な選択肢です。再度選んでください。"
  end

  # こうげき
  def self.atk(atkr)
    nm = atkr.nm                         # 名前
    type = atkr.atk_type                 # タイプ
    nml_atk = Constants::ATK_TYPE_NORMAL # 通常こうげきの値
    mgc_atk = Constants::ATK_TYPE_MAGIC  # 魔法こうげきの値

    # こうげきタイプによってメッセージを変える
    case type
    when nml_atk
      # 通常こうげき
      return "#{nm} のこうげき！"
    when mgc_atk
      # 魔法こうげき
      return "#{nm} は呪文をとなえた！"
    end
  end

  # ダメージ
  def self.dmg(trgt, dmg)
    nm = trgt.nm   # 名前

    "→#{nm} に #{dmg} のダメージ！"
  end

  # キャラクター死滅
  def self.dth(trgt)
    nm = trgt.nm   # 名前

    "→#{nm} は死滅した！"
  end

  # 逃げる
  def self.esc(chrct)
    nm = chrct.nm  # 名前

    "#{nm} は逃げ出した！\n"
  end

  # 勝敗
  def self.jdge(hero_alive)
    hero_alive ? "◆◆◆ 勇者パーティの勝利！ ◆◆◆" : gm_ovr()
  end

  # ゲームオーバー
  def self.gm_ovr
    "◆◆◆ GAME OVER ◆◆◆"
  end
end

# キャラクタークラス
class Character
  # アクセサ
  attr_accessor :nm, :hp, :atk_pwr, :atk_type ,:plyr, :alive

  # キャラクターの初期設定を行う
  def initialize(nm, hp, atk_pwr, atk_type, plyr = false)
    @nm = nm              # キャラクター名
    @hp = hp              # HP
    @atk_pwr = atk_pwr    # こうげき力
    @atk_type = atk_type  # こうげきタイプ
    @plyr = plyr          # プレイヤーフラグ
    @alive = true         # 死滅フラグ
  end

  # ダメージ計算処理
  def atk(trgt)
    vart = Constants::ATK_VARIATION  # こうげきの振れ幅

    # ダメージをランダムに決定(ステータスのこうげき力 ± 振れ幅)
    dmg = rand(@atk_pwr - vart..@atk_pwr + vart)
    trgt.take_dmg(dmg)         # 対象キャラクターにダメージを与える
    dmg                       # 与えたダメージを呼び出し元に返す
  end

  # ダメージ反映処理
  def take_dmg(dmg)
    dead_line = Constants::HP_ZERO # 0定義

    @hp -= dmg  # ダメージ処理

    # 死滅処理
    if @hp <= dead_line
      @hp = dead_line   # HPが0未満にならないよう調整 
      @alive = false    # 死滅フラグを立てる
    end
  end
end

# ゲーム進行クラス
class Game
  # ゲームの初期設定を行う
  def initialize
    # 逃げるフラグを定義
    @esc_flg = false

    # プレイヤーに勇者の名前を入力させる
    show_msg(Message.entr_nm()) # メッセージ表示
    hero_nm = gets.chomp        # 入力受付
    
    # キャラクターの作成
    @heroes = create_heroes(hero_nm)  # 勇者パーティ
    @mnstrs = create_mnstrs()         # モンスターパーティ
  end

  # ゲーム開始処理
  def start
    turn = 0    # ターン数

    # ゲーム開始メッセージ
    show_msg(Message.gm_start())

    # 戦闘ループ
    loop do
      # ゲームの戦況
      turn += 1                         # ターン数カウント
      show_msg(Message.gm_turn(turn))   # ターン数表示
      show_stts()                       # ステータスの表示

      # 勇者パーティのターン
      hero_turn()
      break if prty_dead? || @esc_flg  # 全滅チェックと逃げるフラグチェック

      # モンスターパーティのターン
      mnst_turn()
      break if prty_dead? # 全滅チェック
    end

    # 勝敗表示
    unless @esc_flg
      # 通常の勝敗メッセージ
      show_msg(Message.jdge(@heroes.any?(&:alive)))
    else
      # 逃げ出した場合
      show_msg(Message.gm_ovr()) # ゲームオーバーの表示
    end
  end

  private

  #  勇者パーティの作成
  def create_heroes(hero_nm)
    nml_atk = Constants::ATK_TYPE_NORMAL # 通常こうげきの値
    mgc_atk = Constants::ATK_TYPE_MAGIC  # 魔法こうげきの値

    [
      Character.new(hero_nm, 30, 6, nml_atk, true),  # プレイヤーが操作する勇者
      Character.new('魔法使い', 20, 8, mgc_atk)       # 魔法使い(CPU)
    ]
  end

  # モンスターパーティの作成
  def create_mnstrs
    nml_atk = Constants::ATK_TYPE_NORMAL # 通常こうげきの値
    [
      Character.new('オーク', 30, 8, nml_atk),   # オーク(CPU)
      Character.new('ゴブリン', 25, 6, nml_atk)  # ゴブリン(CPU)
    ]
  end

  # メッセージ表示
  def show_msg(msg, wait = false) # (文字列, 待機時間の有無)
    inv = Constants::DISP_INTERVAL  # 表示待機時間

    puts msg          # 表示
    sleep inv if wait # 指定がある場合は待つ
  end
  
  # キャラクターのステータスを表示する
  def show_stts
    @heroes.each { |hero| show_msg(Message.stts(hero)) }  # 勇者パーティ
    @mnstrs.each { |mnst| show_msg(Message.stts(mnst)) }  # モンスターパーティ
  end

  # 勇者パーティ側のターンを処理
  def hero_turn
    @heroes.each do |hero|
      next unless hero.alive # 死滅したキャラクターは行動をスキップ
      loop do
        atk = Constants::CHOICE_ATK  # こうげき
        esc = Constants::CHOICE_ESC  # 逃げる

        # 行動選択
        if hero.plyr
          # プレイヤーの処理
          show_msg(Message.act_choice(hero)) # メッセージ
          choice = gets.to_i                 # 選択を取得
          
        else
          # 味方の処理
          choice = atk  # こうげきを常時選択
        end

        # 行動
        case choice
        when atk
          # こうげき
          atk_trgt = @mnstrs.select(&:alive).sample  # 対象を絞る
          atk(hero, atk_trgt) if atk_trgt            # こうげき処理
          break
        when esc
          # 逃げる
          esc(hero)   # 逃げる処理
          return
        else
          # 無効な選択
          show_msg(Message.inv_choice())  # エラーメッセージ
        end
      end
    end
  end

  # モンスター側のターンを処理
  def mnst_turn
    @mnstrs.each do |mnst|
      next unless mnst.alive  # 死滅したキャラクターはスキップ

      # こうげき
      atk_trgt = @heroes.select(&:alive).sample    # 対象を絞る
      atk(mnst, atk_trgt) if atk_trgt              # こうげき処理
    end
  end

  # こうげき共通
  def atk(chrct, atk_trgt)
    # こうげきメッセージ
    show_msg(Message.atk(chrct), true)

    # ダメージ処理
    dmg = chrct.atk(atk_trgt)                    # ダメージ計算
    show_msg(Message.dmg(atk_trgt, dmg), true)   # メッセージ

    # 死滅メッセージ
    show_msg(Message.dth(atk_trgt), true) unless atk_trgt.alive
  end

  # 逃げる処理
  def esc(chrct)
    @esc_flg = true                    # 逃げるフラグ
    show_msg(Message.esc(chrct), true) # 逃げる表示
  end

  # 各パーティの全滅チェック
  def prty_dead?
    !@heroes.any?(&:alive) || !@mnstrs.any?(&:alive)  # どちらかが全滅ならtrue
  end
end

# ゲーム開始
gm = Game.new
gm.start
```
</details>

# 2 実践Rubyプログラム：RPGバトルを作ろう！

## 目次
+ [RPGバトルを作ろう](#rpgバトルを作ろう)

<br>

---

## RPGバトルを作ろう

このテキストでは、Rubyを使ってシンプルなRPGバトルを実装します。ターン制バトルを作りながら、Rubyの基本的な構文や概念を復習します。

### ゲームの目的

このゲームの目的は、プレイヤー（勇者）とコンピューター操作のモンスターが戦うターン制バトルを実装することです。プレイヤーは攻撃や魔法を使ってモンスターを倒し、勝利を目指します。

+ **完成イメージ（例）**

  ```sh
  ↓勇者の名前を入力してください↓

  ◆◆◆ モンスターが現れた！ ◆◆◆

  === ターン 1 ===
  ・【リバティ】 HP：30 こうげき力：6
  ・【魔法使い】 HP：20 こうげき力：8
  ・【オーク】 HP：30 こうげき力：8
  ・【ゴブリン】 HP：25 こうげき力：6

  リバティ のターンです。
  ↓行動を選択してください。↓
  【1】こうげき
  【2】逃げる
  リバティ のこうげき！
  →ゴブリン に 4 のダメージ！
  魔法使い は呪文をとなえた！
  →オーク に 9 のダメージ！
  オーク のこうげき！
  →リバティ に 10 のダメージ！
  ゴブリン のこうげき！
  →リバティ に 6 のダメージ！

  === ターン 2 ===
  ・【リバティ】 HP：14 こうげき力：6
  ・【魔法使い】 HP：20 こうげき力：8
  ・【オーク】 HP：21 こうげき力：8
  ・【ゴブリン】 HP：21 こうげき力：6

  リバティ のターンです。
  ↓行動を選択してください。↓
  【1】こうげき
  【2】逃げる
  リバティ のこうげき！
  →ゴブリン に 5 のダメージ！
  魔法使い は呪文をとなえた！
  →ゴブリン に 7 のダメージ！
  オーク のこうげき！
  →魔法使い に 11 のダメージ！
  ゴブリン のこうげき！
  →魔法使い に 5 のダメージ！

  ...

  === ターン 4 ===
  ・【リバティ】 HP：6 こうげき力：6
  ・【魔法使い】 HP：4 こうげき力：8
  ・【オーク】 HP：14 こうげき力：8
  ×【ゴブリン】 HP：0 こうげき力：6

  リバティ のターンです。
  ↓行動を選択してください。↓
  【1】こうげき
  【2】逃げる
  リバティ のこうげき！
  →オーク に 9 のダメージ！
  魔法使い は呪文をとなえた！
  →オーク に 10 のダメージ！
  →オーク は死滅した！
  ◆◆◆ 勇者パーティの勝利！ ◆◆◆
  ```

  <details>
  <summary>もっと見る</summary>
  ```sh
  ↓勇者の名前を入力してください↓

  ◆◆◆ モンスターが現れた！ ◆◆◆

  === ターン 1 ===
  ・【リバティ】 HP：30 こうげき力：6
  ・【魔法使い】 HP：20 こうげき力：8
  ・【オーク】 HP：30 こうげき力：8
  ・【ゴブリン】 HP：25 こうげき力：6

  リバティ のターンです。
  ↓行動を選択してください。↓
  【1】こうげき
  【2】逃げる
  リバティ のこうげき！
  →ゴブリン に 6 のダメージ！
  魔法使い は呪文をとなえた！
  →ゴブリン に 5 のダメージ！
  オーク のこうげき！
  →リバティ に 9 のダメージ！
  ゴブリン のこうげき！
  →魔法使い に 8 のダメージ！

  === ターン 2 ===
  ・【リバティ】 HP：21 こうげき力：6
  ・【魔法使い】 HP：12 こうげき力：8
  ・【オーク】 HP：30 こうげき力：8
  ・【ゴブリン】 HP：14 こうげき力：6

  リバティ のターンです。
  ↓行動を選択してください。↓
  【1】こうげき
  【2】逃げる
  リバティ のこうげき！
  →ゴブリン に 3 のダメージ！
  魔法使い は呪文をとなえた！
  →オーク に 10 のダメージ！
  オーク のこうげき！
  →魔法使い に 10 のダメージ！
  ゴブリン のこうげき！
  →リバティ に 7 のダメージ！

  ...

  === ターン 4 ===
  ・【リバティ】 HP：10 こうげき力：6
  ×【魔法使い】 HP：0 こうげき力：8
  ・【オーク】 HP：14 こうげき力：8
  ・【ゴブリン】 HP：4 こうげき力：6

  リバティ のターンです。
  ↓行動を選択してください。↓
  【1】こうげき
  【2】逃げる
  リバティ のこうげき！
  →オーク に 7 のダメージ！
  オーク のこうげき！
  →リバティ に 11 のダメージ！
  →リバティ は死滅した！
  ◆◆◆ GAME OVER ◆◆◆
  ```
  
  ```sh
  ↓勇者の名前を入力してください↓

  ◆◆◆ モンスターが現れた！ ◆◆◆

  === ターン 1 ===
  ・【リバティ】 HP：30 こうげき力：6
  ・【魔法使い】 HP：20 こうげき力：8
  ・【オーク】 HP：30 こうげき力：8
  ・【ゴブリン】 HP：25 こうげき力：6

  リバティ のターンです。
  ↓行動を選択してください。↓
  【1】こうげき
  【2】逃げる
  リバティ は逃げ出した！
  ◆◆◆ GAME OVER ◆◆◆
  ```

  </summary>

---

### ゲームの流れ
プログラミングをする際には、まずゲームの流れを把握することが重要です。以下のフローチャートは、その流れを簡潔に示したものです。

<img src="images/実践Rubyプログラム/フロー.png" width="500px">

プログラムの流れを理解した上でコーディングを進めることは、非常に効果的です。流れを整理することで、よりスムーズにプログラミングを進めることができます。  

また、プログラムの構成を考えることも大切です。例えば、どのようなクラスを作成するか、どんなメソッドを用意するかなど、正解は一つではありません。このテキストではお手本のコードに沿っていきますが、自分なりに最適な設計を考えてみてもいいかもしれません。  

---
