# 2 実践Rubyプログラム

## 目次
+ [RPGバトルについて](#rpgバトルについて)

<br>

---

### 進行用メソッド作成

ゲームの初期設定はほぼ完了です。次に進行していく流れを作りましょう。同じく`Game`クラスに`start`メソッドを定義してみます。一旦ゲームが始まったことがとりあえずわかるようにアナウンスします。
>`start`メソッドは外部から呼び出すので`private`ではなく`public`として定義しましょう。

`Game.new`で作成したオブジェクトを扱えるように変数`gm`に入れて、`gm.start()`で`start`メソッドを実行します。

```rb
# ゲームを進行するクラス
class Game
  # ゲームの初期設定を行う
  def initialize
    # 略
  end

  # ゲーム進行
  def start
    puts "\n◆◆◆ モンスターが現れた！ ◆◆◆"
  end
  
  private

  # 略

end
  
# ゲーム開始
gm = Game.new
gm.start()
```
```sh
↓勇者の名前を入力してください↓
リバティ # ユーザーが入力

◆◆◆ モンスターが現れた！ ◆◆◆
```

メイン部分を書く前に、事前に以下のメソッドを用意しておきましょう。内容はまだ空で構いません。

+ キャラクターのステータスを表示するメソッド  
+ 勇者のターンを処理するメソッド  
+ モンスターのターンを処理するメソッド  

```rb
# キャラクターのステータスを表示する
def show_stts
  # ここに処理が入る
end

# 勇者パーティ側のターンを処理
def hero_turn
  # ここに処理が入る
end

# モンスター側のターンを処理
def mnst_turn
  # ここに処理が入る
end
```

以下の3つで主にゲームが進行するのでそれぞれのメソッドの呼び出しを`start`メソッドに記述してみましょう。

1. ステータスを表示
1. 勇者パーティのターン
1. モンスターのターン


```rb
def start 
  # 開始メッセージ
  puts "\n◆◆◆ モンスターが現れた！ ◆◆◆"
  
  # ステータス表示
  show_stts()

  # 勇者パーティのターン
  hero_turn()

  # モンスターのターン
  mnst_turn()
end
```

#### やってみよう
`show_stts`に各キャラのステータスを表示させる処理を書いてみましょう。プレビューは以下のとおりです。
```sh
・【リバティ】 HP：30 こうげき力：6
・【オーク】 HP：30 こうげき力：8
```

**※引数の使用の有無は問いません。**

<details>
<summary>コード例</summary>

```rb
# 例1
def show_stts
  puts "・【#{@heroes.nm}】 HP：#{@heroes.hp} こうげき力：#{@heroes.atk_pwr}"
  puts "・【#{@mnstrs.nm}】 HP：#{@mnstrs.hp} こうげき力：#{@mnstrs.atk_pwr}"
end
```
```rb
# 例2 引数を使った場合

# ゲーム進行
def start 
  # 略

  # ステータス表示
  show_stts(@heroes)  # 勇者パーティ表示
  show_stts(@mnstrs)  # モンスターパーティ表示

  # 略
end

# ステータス表示
def show_stts(chrct)
  puts "・【#{chrct.nm}】 HP：#{chrct.hp} こうげき力：#{chrct.atk_pwr}"
end
```
</details>

<br>

---

### 各キャラクターの行動

勇者もモンスターもどちらもこうげきを行います。そのため、これらは共通の処理にすることができます。
`Game`クラス内にこうげき処理用の`atk`メソッドを作りましょう。引数として行動をするキャラクターのオブジェクトと、こうげき対象のオブジェクトを必要とします。

```rb
# こうげき共通
def atk(chrct, atk_trgt)  # (行動をするキャラクター, こうげき対象)
  # こうげきメッセージ
  puts "#{chrct.nm}のこうげき！"
  
  # ダメージ処理
  dmg = chrct.atk()       # ダメージ計算
  atk_trgt.take_dmg(dmg)  # ダメージ反映

  puts "#{atk_trgt.nm} に #{dmg} のダメージ！"  # ダメージ処理
end
```

こうげきにはダメージの処理が必要です。各キャラクターのステータスを握っているのは`Character`クラスなので、ダメージの詳細な処理はそこに作ります。

#### ダメージ処理を作ってみよう

ダメージを計算するメソッドとダメージをステータスに反映するメソッドを書いてみましょう。

+ `Character`クラス

  + `atk`(こうげきのダメージを計算するメソッド)
    + こうげきするキャラクターのこうげき力をダメージとして返す

  + `take_dmg`(ダメージを実際に反映するメソッド)
    + 受け取ったダメージをもとにこうげき対象のHPを引く

<details>
<summary>コード例</summary>

```rb
class Character
  # 略

  # ダメージ計算処理
  def atk
    @atk_pwr  # ダメージ
  end

  # ダメージ反映処理
  def take_dmg(dmg)
    @hp -= dmg  # ダメージ処理
  end
end
```
</details>

---

##### こうげき力に振れ幅を持たせる
簡易的ですが、ダメージ処理の一連の処理は完成しました。  
しかし、これではダメージは一定になってしまい、ゲームとしては面白みがあまりありません。こうげき力に振れ幅を持たせてあげましょう。

+ 定数クラスにダメージの振れ幅の定数を定義し、値を`3`にする
+ ダメージが`こうげき力 ± 3`の範囲でランダムで返されるようにする

>**ヒント**:ランダムは`rand`メソッドを使うと実現できます。

<details>
<summary>コード例</summary>

```rb
# 定数管理クラス
class Constants
  # 略

  ATK_POW_VARIATION = 3  # こうげき力の触れ幅
end

# キャラクタークラス
class Character
  # 略

  # ダメージ計算処理
  def atk
    # ランダムダメージ(こうげき力±振れ幅)
    rand(@atk_pwr - Constants::ATK_POW_VARIATION..@atk_pwr + Constants::ATK_POW_VARIATION) 
  end

  # 略
end
```
</details>

少しずつそれっぽくなってきましたね。  

---

##### HPに最低値をもたせる
ダメージを処理を繰り返していくとそのうちHPがマイナスになってしまうので、`0`で止まるように処理を`take_dmg`に加えましょう。また、同時にこうげき対象キャラクターの生存フラグも下ろして、死滅にします。

+ 定数クラスにHPの最低値のゼロを示す定数を定義し、値を`0`にする
+ ダメージ処理後に値が`0未満`の場合は強制的に`0`にする
+ こうげき対象キャラクターの生存フラグを`false`にする

```rb
# 定数管理クラス
class Constants
  # 略

  HP_ZERO = 0  # HPが0
end

# キャラクタークラス
class Character
  # 略

  # ダメージ反映処理
  def take_dmg(dmg)
    @hp -= dmg  # ダメージ処理

    # 死滅処理
    if @hp <= Constants::HP_ZERO
      @hp = Constants::HP_ZERO   # HPが0未満にならないよう調整 
      @alive = false             # 生存フラグを下ろす
    end
  end

  # 略
end
```

---

#### 各パーティの処理にこうげきメソッドを組み込もう

先ほど作った`Game`クラスの`atk`メソッドを`hero_turn`メソッドと`mnst_turn`で呼び出します。

```rb
# 勇者パーティのターン
def hero_turn
  atk(@heroes, @mnstrs) # (行動をするキャラクター, こうげき対象)
end

# モンスターのターン
def mnst_turn
  atk(@mnstrs, @heroes) # (行動をするキャラクター, こうげき対象)
end
```

---

#### 逃げるメソッドを作ってみよう
ときには勇者だって逃げたくなる時もあります。そんな勇者のために`Game`クラスに逃げるメソッドを用意してあげましょう。
また、逃げる選択をした場合はゲームオーバーになるので、後ほど終了判定を作るためにフラグを用意します。

```ruby
# ゲームの初期設定
def initialize
  @esc_flg = false  # 逃げるフラグ

  # 略
end

# 略

# 逃げる
def esc(chrct)
  puts "#{chrct.nm}は逃げ出した！"  
  @esc_flg = true # 逃げるフラグを立てる
end
```
これで逃げ出した場合の判定フラグを用意することができました。

---

#### 勇者の行動を選択できるようにしよう
現状のコードのままだと、勇者は自動的に攻撃をするだけになります。ユーザーが入力した値を受け取って、それをもとに処理をわけてあげましょう。

+ `hero_turn`でプレイヤーの行動の入力を受け付ける
+ `1`が入力されたらこうげきメソッドを呼び出す
+ `2`が入力されたら逃げるメソッドを呼び出し、その後`hero_turn`メソッドをそのまま抜ける
+ 上記それぞれの値を定数にする
+ 指定した値以外が入力された場合は`無効な選択肢です。再度選んでください。`と表示し、再び入力を受け付ける

```sh
↓勇者の名前を入力してください↓
リバティ # ユーザーが入力
◆◆◆ モンスターが現れた！ ◆◆◆
・【リバティ】 HP：30 こうげき力：6
・【オーク】 HP：30 こうげき力：8

リバティ のターンです。
↓行動を選択してください↓
【1】こうげき
【2】逃げる
# ここにユーザーのコマンドが入る
```
<details>
<summary>コード例</summary>

```rb
# 定数管理クラス
class Constants
  # 略

  # 行動選択
  CHOICE_ATK = 1  # こうげき
  CHOICE_ESC = 2  # 逃げる
end

# 勇者パーティのターン
def hero_turn
  loop do
    puts "\n↓行動を選択してください↓"
    puts "【#{Constants::CHOICE_ATK}】こうげき"
    puts "【#{Constants::CHOICE_ESC}】逃げる"
    choice = gets.to_i  # 行動の入力を整数で受け付ける
    
    # 行動
    case choice
    when Constants::CHOICE_ATK
      # こうげき
      atk(@heroes, @mnstrs) # こうげき処理
      break                 # ループを抜ける
    when Constants::CHOICE_ESC
      # 逃げる
      esc(@heroes)   # 逃げる処理
      return         # メソッドを抜ける
    else
      # 無効な選択
      puts "無効な選択肢です"
    end
  end
end
```

>このコードでは`gets`を`to_i`で整数に変換していますが、文字列を受け取った場合は`0`として変換されてしまうことに注意が必要です。
</details>

---

#### 逃げたらゲームを終わらせよう
先ほど作った`@esc_flg`を勇者のターンのメソッド処理が終わったら確認して、もしフラグが立っていたらメソッドを抜けます。

```ruby
# ゲーム開始処理
def start
  # 略

  # 勇者パーティのターン
  hero_turn()

  return if @esc_flg  # 逃げた場合は終了 

  # モンスターのターン
  mnst_turn()
end
```

---

### ここまでの動作を確認しよう
やや難しくなってきたところで、ここまでの動作を確認します。
うまく動作しなかった人は今一度自分のコードを振り返ってみましょう。まずは自力で挑戦して、わからないところはお手本のコードと見比べながら改善してみましょう！

```sh
↓勇者の名前を入力してください↓
リバティ # ユーザーが入力
◆◆◆ モンスターが現れた！ ◆◆◆
・【リバティ】 HP：30 こうげき力：6
・【オーク】 HP：30 こうげき力：8

↓行動を選択してください↓
【1】こうげき
【2】逃げる
1 # ユーザーが入力
リバティのこうげき！
オーク に 4 のダメージ！
オークのこうげき！
リバティ に 6 のダメージ！
```

```sh
↓勇者の名前を入力してください↓
リバティ # ユーザーが入力
◆◆◆ モンスターが現れた！ ◆◆◆
・【リバティ】 HP：30 こうげき力：6
・【オーク】 HP：30 こうげき力：8

↓行動を選択してください↓
【1】こうげき
【2】逃げる
2 # ユーザーが入力
リバティ は逃げ出した！
```

<details>
<summary>コード例</summary>

```rb
# 定数管理クラス
class Constants
  # ダメージ
  HP_ZERO = 0            # HPが0
  ATK_POW_VARIATION = 3  # こうげき力の触れ幅

  # 行動選択
  CHOICE_ATK = 1  # こうげき
  CHOICE_ESC = 2  # 逃げる
end
  
# キャラクタークラス
class Character
  # アクセサ
  attr_accessor :nm, :hp, :atk_pwr, :atk_type ,:plyr, :alive

  # キャラクターの初期設定を行う
  def initialize(nm, hp, atk_pwr, atk_type, plyr = false)
    @nm = nm              # キャラクター名
    @hp = hp              # HP
    @atk_pwr = atk_pwr    # こうげき力
    @atk_type = atk_type  # こうげきタイプ(通常:1 魔法:2)
    @plyr = plyr          # プレイヤーフラグ
    @alive = true         # 生存フラグ
  end

  # ダメージ計算処理
  def atk
    # ランダムダメージ(こうげき力±振れ幅)
    rand(@atk_pwr - Constants::ATK_POW_VARIATION..@atk_pwr + Constants::ATK_POW_VARIATION) 
  end

  # ダメージ反映処理
  def take_dmg(dmg)
    @hp -= dmg  # ダメージ処理

    # 死滅処理
    if @hp <= Constants::HP_ZERO
      @hp = Constants::HP_ZERO   # HPが0未満にならないよう調整 
      @alive = false             # 生存フラグを下ろす
    end
  end
end

# ゲームを進行するクラス
class Game
  # ゲームの初期設定を行う
  def initialize
    @esc_flg = false  # 逃げるフラグ

    puts "↓勇者の名前を入力してください↓"
    hero_nm = gets.chomp  # 入力受付
    
    # キャラクターを作成
    @heroes = create_heroes(hero_nm)
    @mnstrs = create_mnstrs()
  end

  # ゲーム開始処理
  def start
    # 開始メッセージ
    puts "\n◆◆◆ モンスターが現れた！ ◆◆◆"
    
    # ステータス表示
    show_stts(@heroes)  # 勇者パーティ表示
    show_stts(@mnstrs)  # モンスターパーティ表示

    # 勇者パーティのターン
    hero_turn()

    return if @esc_flg  # 逃げた場合は終了

    # モンスターのターン
    mnst_turn()
  end
  
  private

  # 勇者パーティの作成
  def create_heroes(hero_nm)
    Character.new(hero_nm, 30, 6, 1, true)  # プレイヤーが操作する勇者
  end

  # モンスターパーティの作成
  def create_mnstrs
    Character.new('オーク', 30, 8, 1)   # オーク(CPU)
  end

  # こうげき共通
  def atk(chrct, atk_trgt)  # (行動をするキャラクター, こうげき対象)
    # こうげきメッセージ
    puts "#{chrct.nm}のこうげき！"
    
    # ダメージ処理
    dmg = chrct.atk()       # ダメージ計算
    atk_trgt.take_dmg(dmg)  # ダメージ反映

    puts "#{atk_trgt.nm} に #{dmg} のダメージ！"  # ダメージ処理
  end

  # 逃げる
  def esc(chrct)
    puts "#{chrct.nm}は逃げ出した！"  
    @esc_flg = true # 逃げるフラグを立てる
  end

  # ステータス表示
  def show_stts(chrct)
    puts "・【#{chrct.nm}】 HP：#{chrct.hp} こうげき力：#{chrct.atk_pwr}"
  end

  # 勇者パーティのターン
  def hero_turn
    loop do
      puts "\n↓行動を選択してください↓"
      puts "【#{Constants::CHOICE_ATK}】こうげき"
      puts "【#{Constants::CHOICE_ESC}】逃げる"
      choice = gets.to_i  # 行動の入力を整数で受け付ける
    
      # 行動
      case choice
      when Constants::CHOICE_ATK
        # こうげき
        atk(@heroes, @mnstrs) # こうげき処理
        break                 # ループを抜ける
      when Constants::CHOICE_ESC
        # 逃げる
        esc(@heroes)   # 逃げる処理
        return  # メソッドを抜ける
      else
        # 無効な選択
        puts "無効な選択肢です"
      end
    end
  end
  
  # モンスターのターン
  def mnst_turn
    atk(@mnstrs, @heroes) # (行動をするキャラクター, こうげき対象)
  end
end
  
# ゲーム開始
gm = Game.new
gm.start()
```
</details>