# FruitShop 商品投稿機能の実装
## 商品投稿の流れ

ウェブアプリケーションで商品情報を投稿する際、以下のような手順で処理されます。

1. **フォーム画面を表示する**  
  ユーザーが商品情報を入力できる画面（ページ）を表示します。

1. **フォームにデータを入力し、送信する**  
 商品名や価格などの情報を入力し、「投稿」ボタンをクリックします。

1. **送信内容をサーバーで受け取り、データベースへ保存する**  
  入力された情報がサーバーに送信され、コントローラーがデータを受け取り、データベースに保存します。

1. **投稿後にリダイレクトする**  
  投稿が完了した後、トップページや投稿一覧ページなど、適切なページへ移動します。

このように、投稿機能には「入力」「送信」「受け取り」「保存」「リダイレクト」のステップが含まれます。  
それでは、各ステップを実装するための流れを詳しく見ていきましょう。

## 実装の流れ

ウェブアプリでデータをやり取りするためには、以下のような仕組みを作る必要があります。

1. **データベースの準備**  
  商品情報を格納するための `products` テーブルを作成します。


1. **ルーティングの設定**  
  「どのURLにアクセスしたときに、どの処理を実行するのか」を決めます。  
    例えば、「/products/new にアクセスしたらフォームを表示する」「/products にデータを送信したら商品を保存する」などのルールを定義します。

1. **コントローラーの作成**  
  コントローラーは、リクエストを受け取って処理を行う部分です。  
    フォーム画面を表示したり、送信されたデータを受け取って保存する役割を持ちます。

1. **ビューの作成（投稿フォーム）**  
  ユーザーが入力する画面を作成します。  
    ここで作成したフォームを通じて、データが送信されます。

1. **データの保存**  
  ユーザーが入力したデータをデータベースに保存します。  
    コントローラーがデータを受け取り、モデルを使ってデータベースに登録します。

1. **投稿後のリダイレクト**  
  投稿が成功したら、適切なページに移動（リダイレクト）させます。
    例えば、投稿一覧ページに戻ることで、投稿が正しく反映されたことを確認できます。

このように、リクエストの流れを意識しながら実装を進めることで、投稿機能がどのように動作するのか理解しやすくなります。  
次の章では、それぞれのステップを具体的に実装していきます。

## 実装の流れ

ウェブアプリで商品を投稿・管理するためには、以下の手順で実装を進めます。


## 事前準備

商品情報を管理するための `products` テーブルを作成します。

```ruby
# db/migrate/XXXXXX_create_products.rb
class CreateProducts < ActiveRecord::Migration[7.1]
  def change
    create_table :products do |t|
      t.string :name, null: false  # 商品名（必須）
      t.text :description          # 商品説明
      t.integer :price, null: false # 価格
      t.timestamps                 # 作成日時と更新日時
    end
  end
end
```

### マイグレーションの適用

作成したマイグレーションをデータベースに適用します。

```sh
rails db:migrate
```

### モデルの作成

データベースとのやり取りを行う `Product` モデルを作成します。

```sh
rails generate model Product name:string description:text price:integer
```

```ruby
# app/models/product.rb
class Product < ApplicationRecord
  validates :name, presence: true  # 商品名は必須
  validates :price, presence: true # 価格は必須
end
```

### モデルのポイント

- `rails generate model Product name:string description:text price:integer`
  - `Product` モデルを作成し、対応するマイグレーションファイルを自動生成します。
- `validates :name, presence: true`
  - `name` は必須項目としてバリデーションを追加。
- `validates :price, presence: true`
  - `price` も必須項目としてバリデーションを追加。



## ルーティングの設定

フォームを記述したビューを表示するためのルーティングを設定します。
コントローラーをアクション付きで作成した場合、new アクションへのルーティングは自動で生成されます。
しかし、データを追加（保存）するためのルーティングは生成されていないため、明示的に追加する必要があります。

```ruby
# app/config/routes.rb
Rails.application.routes.draw do
  get 'products/new'  # 商品投稿フォームを表示
  post 'products' => 'products#create'  # 商品を保存する
end
```

### ルーティングのポイント
- `get 'products/new'`
  - 商品の投稿フォームを表示するためのルーティング。
  - `/products/new` にアクセスすると `products_controller.rb` の `new` アクションが実行されます。

- `post 'products' => 'products#create'`
  - 投稿フォームから送信されたデータを受け取り、保存するためのルーティング。
  - `POST /products` へのリクエストは `products_controller.rb` の `create` アクションに送られます。

  ## コントローラーの作成

  商品を投稿する `ProductsController` を作成します。まずは新規作成用の `new` アクションと、投稿を保存するための `create` アクションを定義します。

  ```sh
  rails generate controller Products new create
  ```

  作成された `app/controllers/products_controller.rb` を編集します。

  ```ruby
  # app/controllers/products_controller.rb
  class ProductsController < ApplicationController
    def new
      # 新しい商品を作成するための空のインスタンスを用意
      @product = Product.new
    end

    def create
      # フォームから送られたデータを元に新しい商品を作成
      @product = Product.new(product_params)
      
      # データをデータベースに保存する
      if @product.save
        # 成功した場合、トップページへリダイレクトし、メッセージを表示
        redirect_to root_path, notice: '商品が投稿されました。'
      else
        # 失敗した場合、入力内容を保持したままフォームを再表示
        render :new, status: :unprocessable_entity
      end
    end

    private
    # ストロングパラメータで、フォームから送信されたデータを許可する
    def product_params
      params.require(:product).permit(:name, :description, :price)
    end
  end
  ```

  ### 解説

  #### newアクション

  `@product = Product.new` によって、空の `Product` インスタンスを作成し、ビューに渡します。このインスタンスは、フォームの入力欄にデフォルト値を設定するために使われます。

  #### createアクション

  フォームから送られてきたデータを `product_params` メソッドで受け取り、新しい `Product` オブジェクトを作成します。`@product.save` でデータベースに保存し、保存が成功した場合は、トップページにリダイレクトします。失敗した場合は、フォームを再表示して、エラーメッセージを表示します。

  #### ストロングパラメータ

  `product_params` メソッドでは、フォームから送信されたデータを制限しています。これにより、マスアサインメント脆弱性を防ぐことができます。`params.require(:product).permit(:name, :description, :price)` によって、`name`, `description`, `price` のカラムだけがデータベースに保存されます。
  

  ## Viewファイルの変更

  次に、対応するビューを作成します。

  ```erb
  <!-- app/views/products/new.html.erb -->
  <h1>新規商品投稿</h1>
  <%= form_with model: @product do |f| %>
    <h4>商品名</h4>
    <%= f.text_field :name %>

    <h4>商品説明</h4>
    <%= f.text_area :description %>

    <h4>価格</h4>
    <%= f.number_field :price %>

    <%= f.submit '投稿' %>
  <% end %>
  ```

  これで商品投稿のフォームが完成し、`new` アクションで空の `Product` インスタンスを渡し、`create` アクションでそのデータを保存します。

  ### まとめ

  - コントローラーでは、`new` と `create` アクションを使って、商品投稿の処理を行います。
  - ストロングパラメータを使って、フォームから送信されるデータを制限し、安全にデータを保存します。
  - フォームは、`form_with` を使って `@product` に基づいた投稿フォームを作成します。

### **データの保存とリダイレクト**
投稿後、適切なページにリダイレクトし、フラッシュメッセージを表示します。

- 保存成功時 → 投稿ページへリダイレクト (`new_product_path`)
- 失敗時 → 投稿フォームを再表示 (`render :new`)


これで、基本的な商品投稿機能が完成します！

