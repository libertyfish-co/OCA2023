# 6 Ruby on Rails：データベース基礎

## 目次

  - [多対多の関連付け](#多対多の関連付け)
    - [(1) 1対1の関連付け](#1-1対1の関連付け)
    - [(2) 多対1の関連付け](#2-多対1の関連付け)
    - [(3) 多対多の関連付け](#3-多対多の関連付け)
    - [(4) 中間テーブルの役割と必要性](#4-中間テーブルの役割と必要性)
    - [実装例: Railsでの関連付け](#実装例-railsでの関連付け)

## 多対多の関連付け  

データベースの設計において、「1対1」「多対1」「多対多」という3つの主要な関連付けがあります。これらの関連付けは、データベース内のテーブル間でどのようにデータが結びつくかを表します。今回はそれぞれの特徴と「多対多」の関係を初心者にもわかりやすく解説します。  

---

### (1) 1対1の関連付け

**特徴**  
- 一方のテーブルの1つのレコードが、もう一方のテーブルの1つのレコードに関連付けられる関係です。  

**例**  
生徒と学生証の関係。各生徒は1枚の学生証を持ち、それぞれの学生証は特定の生徒に紐づいています。  

- 生徒テーブル (students): 生徒の情報を保存  
- 学生証テーブル (student_ids): 学生証の情報を保存  

| 生徒テーブル     | 学生証テーブル     |
| ---------------- | ------------------ |
| id: 生徒のID     | id: 学生証のID     |
| name: 生徒の名前 | student_id: 生徒ID |
| age: 年齢        | issue_date: 発行日 |

---

### (2) 多対1の関連付け 

**特徴**  
- 複数のレコードが、1つの共通のレコードに関連付けられる関係です。  

**例**  
学校と教室の関係。1つの学校は複数の教室を持ちますが、各教室は1つの学校に属します。  

- 学校テーブル (schools): 学校の情報を保存  
- 教室テーブル (classrooms): 教室の情報を保存  

| 学校テーブル  | 教室テーブル          |
| ------------- | --------------------- |
| id: 学校のID  | id: 教室のID          |
| name: 学校名  | room_number: 部屋番号 |
| address: 住所 | school_id: 学校ID     |

---

### (3) 多対多の関連付け 

**特徴**  
- 一方のテーブルの複数のレコードが、もう一方のテーブルの複数のレコードと関連付けられる関係です。  
- 多対多の関係を管理するためには「中間テーブル」が必要です。  

---

### (4) 中間テーブルの役割と必要性  

多対多の関係では、直接関連付けを表現することが難しいため、「中間テーブル」を作成して、データ間の関連を管理します。  

**例: 生徒と部活の関係**  
- 生徒は複数の部活に参加できます。  
- 部活も複数の生徒を受け入れることができます。  

以下のように中間テーブルを使わない場合、テーブルが複雑化し、管理が困難になります。

**中間テーブルを使用しない場合の問題点**  
- 各部活に所属する生徒IDをカラムに追加すると、カラム数が増え、NULL値が増加する。  
- 新しい部活や生徒を追加するたびに、テーブルを変更する必要がある。

---

#### 中間テーブルを導入した場合  

以下の3つのテーブルを用意します。  
1. **生徒テーブル (students)**: 生徒の情報を保存  
2. **部活テーブル (clubs)**: 部活の情報を保存  
3. **中間テーブル (club_students)**: 生徒と部活の関係を保存  

#### 生徒テーブル  

| id  | 生徒名   |
| --- | -------- |
| 1   | 山田太郎 |
| 2   | 鈴木花子 |
| 3   | 高橋一郎 |

#### 部活テーブル  

| id  | 部活名     |
| --- | ---------- |
| 1   | サッカー部 |
| 2   | 吹奏楽部   |

#### 中間テーブル  

| id  | 生徒ID | 部活ID |
| --- | ------ | ------ |
| 1   | 1      | 1      |
| 2   | 1      | 2      |
| 3   | 2      | 2      |
| 4   | 3      | 1      |

中間テーブルを導入することで、以下のような利点があります：  
- **柔軟性が向上**: 新しい生徒や部活を追加しても、テーブルの構造を変更する必要がありません。  
- **検索が効率的**: 関連するデータを簡単に取得できます。  

---

### 実装例: Railsでの関連付け  

Railsでは、多対多の関連付けを`has_many :through`を使って簡単に設定できます。  

```ruby
class Student < ApplicationRecord
  has_many :club_students
  has_many :clubs, through: :club_students
end

class Club < ApplicationRecord
  has_many :club_students
  has_many :students, through: :club_students
end

class ClubStudent < ApplicationRecord
  belongs_to :student
  belongs_to :club
end
```

